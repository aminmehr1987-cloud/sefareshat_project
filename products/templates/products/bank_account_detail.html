{% extends 'products/base.html' %}
{% load custom_filters %}
{% block title %}{{ title }}{% endblock %}

{% block customer_elements %}{% endblock customer_elements %}{% block cart_elements %}{% endblock cart_elements %}

{% block content %}
<style>
  .bank-account-detail-container {
    max-width: 1200px;
    margin: 20px auto;
    background: rgba(255,255,255,0.1);
    border-radius: 24px;
    padding: 24px 24px 18px 24px;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(23, 162, 184, 0.3);
    box-shadow: 0 4px 20px rgba(0,0,0,0.10);
    font-family: 'b homa', Tahoma, sans-serif;
    box-sizing: border-box;
    transition: all 0.25s;
  }
  
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }
  
  h3 {
    color: #000;
    text-align: center;
    margin: 0;
    font-size: 24px;
    font-weight: bold;
  }
  
  .back-btn {
    display: inline-block;
    padding: 8px 16px;
    background: #6c757d;
    color: #fff;
    text-decoration: none;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.3s;
  }
  
  .back-btn:hover {
    background: #5a6268;
    color: #fff;
    text-decoration: none;
  }
  
  .edit-btn {
    display: inline-block;
    padding: 8px 16px;
    background: #ffc107;
    color: #212529;
    text-decoration: none;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.3s;
    margin-left: 10px;
  }
  
  .edit-btn:hover {
    background: #e0a800;
    color: #212529;
    text-decoration: none;
  }
  
  .account-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
    padding: 20px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
  }
  
  .info-item {
    display: flex;
    flex-direction: column;
  }
  
  .info-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
  }
  
  .info-value {
    font-size: 16px;
    font-weight: bold;
    color: #000;
  }
  
  .balance-section {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    text-align: center;
  }
  
  .balance-amount {
    font-size: 2rem;
    font-weight: bold;
    color: #1976d2;
    margin-bottom: 10px;
  }
  
  .checkbooks-section {
    margin-top: 30px;
  }
  
  .section-title {
    font-size: 20px;
    font-weight: bold;
    color: #000;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(23, 162, 184, 0.3);
  }
  
  .checkbook-card {
    background: rgba(255,255,255,0.9);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid rgba(23, 162, 184, 0.2);
  }
  
  .checkbook-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(23, 162, 184, 0.2);
  }
  
  .checkbook-title {
    font-size: 18px;
    font-weight: bold;
    color: #17a2b8;
  }
  
  .checkbook-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
  }
  
  .status-active {
    background: #d4edda;
    color: #155724;
  }
  
  .status-inactive {
    background: #f8d7da;
    color: #721c24;
  }
  
  .checks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 15px;
  }
  
  .check-item {
    background: rgba(255,255,255,0.8);
    border-radius: 8px;
    padding: 10px;
    border: 1px solid rgba(23, 162, 184, 0.2);
    text-align: center;
  }
  
  .check-number {
    font-weight: bold;
    color: #17a2b8;
    margin-bottom: 5px;
  }
  
  .check-status {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 12px;
  }
  
  .status-used {
    background: #f8d7da;
    color: #721c24;
  }
  
  .status-available {
    background: #d4edda;
    color: #155724;
  }
  
  .add-checkbook-btn {
    background: linear-gradient(135deg, #17a2b8, #138496);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 20px;
  }
  
  .add-checkbook-btn:hover {
    background: linear-gradient(135deg, #138496, #117a8b);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
    color: white;
    text-decoration: none;
  }
  
  .empty-message {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
  }

  /* جدول دسته چک‌ها */
  .checkbooks-table {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
    border: 1px solid rgba(0,0,0,0.1);
  }

  .checkbooks-header {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr 2fr;
    gap: 10px;
    padding: 15px;
    background: linear-gradient(135deg, #17a2b8, #138496);
    color: white;
    font-weight: bold;
    font-size: 14px;
  }

  .checkbook-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr 2fr;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    align-items: center;
    transition: background-color 0.3s;
  }

  .checkbook-row:hover {
    background: rgba(23, 162, 184, 0.1);
  }

  .checkbook-row:last-child {
    border-bottom: none;
  }

  .checkbook-col {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 14px;
  }

  .checkbook-serial {
    font-weight: bold;
    color: #17a2b8;
  }

  .checkbook-number {
    font-weight: bold;
    color: #495057;
  }

  .checkbook-count {
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
  }

  .total-count {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    color: #1976d2;
  }

  .used-count {
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    color: #f57c00;
  }

  .remaining-count {
    background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
    color: #388e3c;
  }

  .checkbook-actions {
    display: flex;
    gap: 5px;
    justify-content: center;
  }

  .checkbook-actions .btn {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 4px;
  }

  .checkbook-actions .btn-info {
    background: #17a2b8;
    border-color: #17a2b8;
  }

  .checkbook-actions .btn-warning {
    background: #ffc107;
    border-color: #ffc107;
    color: #212529;
  }

  .checkbook-actions .btn-success {
    background: #28a745;
    border-color: #28a745;
  }

  .checkbook-actions .btn:hover {
    opacity: 0.8;
  }

  /* بخش چک‌های واگذاری */
  .deposited-checks-section {
    margin-top: 30px;
    padding: 20px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.1);
  }

  .deposited-checks-actions {
    margin-bottom: 20px;
    text-align: center;
  }

  .list-checks-btn {
    display: inline-block;
    padding: 12px 24px;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    transition: all 0.3s;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
  }

  .list-checks-btn:hover {
    background: linear-gradient(135deg, #218838, #1e7e34);
    transform: translateY(-1px);
    color: white;
    text-decoration: none;
  }

  .list-checks-btn i {
    margin-left: 8px;
  }

  /* جدول چک‌های واگذاری */
  .deposited-checks-table {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
    border: 1px solid rgba(0,0,0,0.1);
  }

  .deposited-checks-header {
    display: grid;
    grid-template-columns: 1.5fr 1.5fr 1.5fr 2fr 2fr 1.5fr 1.5fr 1fr 1.5fr 1.5fr;
    gap: 10px;
    padding: 15px;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    font-weight: bold;
    font-size: 14px;
  }

  .deposited-check-row {
    display: grid;
    grid-template-columns: 1.5fr 1.5fr 1.5fr 2fr 2fr 1.5fr 1.5fr 1fr 1.5fr 1.5fr;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    align-items: center;
    transition: background-color 0.3s;
  }

  .deposited-check-row:hover {
    background: rgba(40, 167, 69, 0.1);
  }

  .deposited-check-row:last-child {
    border-bottom: none;
  }

  .check-col {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 14px;
  }

  .check-sayadi {
    font-weight: bold;
    color: #007bff;
  }

  .check-amount {
    font-weight: bold;
    color: #28a745;
  }

  .check-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
  }

  .status-deposited {
    background: #d4edda;
    color: #155724;
  }

  /* باکس جستجوی پیشرفته */
  .advanced-search {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(0,0,0,0.1);
  }

  .search-toggle {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    margin-bottom: 15px;
    transition: all 0.3s;
  }

  .search-toggle:hover {
    background: #138496;
  }

  .search-fields {
    display: none;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-top: 20px;
    padding: 20px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.1);
    width: 100%;
    box-sizing: border-box;
  }

  .search-fields.show {
    display: grid;
  }

  .search-field {
    display: flex;
    flex-direction: column;
    position: relative;
    min-width: 0;
    width: 100%;
  }

  .search-field label {
    font-size: 12px;
    color: #666;
    margin-bottom: 8px;
    font-weight: bold;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-field input,
  .search-field select {
    padding: 8px 10px;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 6px;
    background: rgba(255,255,255,0.9);
    font-size: 13px;
    height: 36px;
    transition: all 0.3s;
    width: 100%;
    box-sizing: border-box;
    min-width: 0;
    max-width: 100%;
  }

  .search-field input:focus,
  .search-field select:focus {
    outline: none;
    border-color: #17a2b8;
    box-shadow: 0 0 0 2px rgba(23, 162, 184, 0.2);
    background: white;
  }

  /* Specific styling for date inputs */
  .search-field input.date-input {
    background: rgba(255,255,255,0.95);
    cursor: pointer;
  }

  .search-field input.date-input:hover {
    background: white;
    border-color: #17a2b8;
  }

  /* Responsive grid adjustments */
  @media (max-width: 1400px) {
    .search-fields {
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
  }

  @media (max-width: 1000px) {
    .search-fields {
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
  }

  @media (max-width: 600px) {
    .search-fields {
      grid-template-columns: 1fr;
      gap: 15px;
      padding: 15px;
    }
    
    .search-field input,
    .search-field select {
      height: 40px;
      font-size: 16px;
    }
  }

  .search-actions {
    margin-top: 20px;
    display: flex;
    gap: 15px;
    justify-content: center;
    padding: 15px;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    border-top: 1px solid rgba(0,0,0,0.1);
  }

  .search-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s;
    min-width: 120px;
  }

  .search-btn:hover {
    background: #218838;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
  }

  .clear-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s;
    min-width: 120px;
  }

  .clear-btn:hover {
    background: #5a6268;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
  }

  /* استایل‌های جدید برای فیلدهای اضافه شده */
  .check-endorsement {
    font-weight: bold;
    color: #6f42c1;
  }

  .check-serial {
    font-weight: bold;
    color: #fd7e14;
  }

  .check-customer {
    font-weight: bold;
    color: #20c997;
  }

  /* عملیات چک */
  .check-operations {
    display: flex;
    gap: 8px;
    justify-content: center;
    align-items: center;
  }

  .operation-btn {
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }

  .clear-btn-op {
    background: #28a745;
    color: white;
  }

  .clear-btn-op:hover {
    background: #218838;
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
  }

  .bounce-btn-op {
    background: #dc3545;
    color: white;
  }

  .bounce-btn-op:hover {
    background: #c82333;
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
  }

  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    text-align: center;
  }

  .status-badge.cleared {
    background: #d4edda;
    color: #155724;
  }

  .status-badge.bounced {
    background: #f8d7da;
    color: #721c24;
  }

  /* Responsive design */
  @media (max-width: 1400px) {
    .deposited-checks-header,
    .deposited-check-row {
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
      gap: 8px;
      padding: 12px;
      font-size: 12px;
    }
  }

  @media (max-width: 1000px) {
    .deposited-checks-header,
    .deposited-check-row {
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
      gap: 6px;
      padding: 10px;
      font-size: 11px;
    }

    .check-col:nth-child(n+6) {
      display: none;
    }
  }

  @media (max-width: 768px) {
    .deposited-checks-header,
    .deposited-check-row {
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 5px;
      padding: 8px;
      font-size: 10px;
    }

    .check-col:nth-child(n+5) {
      display: none;
    }

    .search-actions {
      flex-direction: column;
      align-items: center;
    }
    
    .search-btn,
    .clear-btn {
      width: 100%;
      max-width: 200px;
    }
  }
  
  @media (max-width: 600px) {
    .deposited-checks-header,
    .deposited-check-row {
      grid-template-columns: 1fr 1fr 1fr;
      gap: 4px;
      padding: 6px;
      font-size: 9px;
    }

    .check-col:nth-child(n+4) {
      display: none;
    }
    
    .search-actions {
      padding: 10px;
    }
  }
  
  @media (max-width: 480px) {
    .deposited-checks-header,
    .deposited-check-row {
      grid-template-columns: 1fr 1fr;
      gap: 3px;
      padding: 5px;
      font-size: 8px;
    }

    .check-col:nth-child(n+3) {
      display: none;
    }
  }
</style>

<div class="bank-account-detail-container">
  <div class="page-header">
    <h3>{{ title }}</h3>
    <div>
      <a href="{% url 'products:bank_account_list' %}" class="back-btn">
        بازگشت به لیست
      </a>
      <a href="{% url 'products:bank_account_edit' bank_account.id %}" class="edit-btn">
        ویرایش
      </a>
      <a href="{% url 'products:bank_statement' bank_account.id %}" class="edit-btn" style="background: #28a745; color: white;">
        صورتحساب
      </a>
    </div>
  </div>
  
  <div class="account-info">
    <div class="info-item">
      <span class="info-label">بانک:</span>
      <span class="info-value">{{ bank_account.bank.name }}</span>
    </div>
    <div class="info-item">
      <span class="info-label">عنوان حساب:</span>
      <span class="info-value">{{ bank_account.title }}</span>
    </div>
    <div class="info-item">
      <span class="info-label">شماره حساب:</span>
      <span class="info-value">{{ bank_account.account_number }}</span>
    </div>
    <div class="info-item">
      <span class="info-label">نوع حساب:</span>
      <span class="info-value">{{ bank_account.get_account_type_display }}</span>
    </div>
    <div class="info-item">
      <span class="info-label">شماره شبا:</span>
      <span class="info-value">{{ bank_account.sheba }}</span>
    </div>
    {% if bank_account.card_number %}
    <div class="info-item">
      <span class="info-label">شماره کارت:</span>
      <span class="info-value">{{ bank_account.card_number }}</span>
    </div>
    {% endif %}
    <div class="info-item">
      <span class="info-label">وضعیت:</span>
      <span class="info-value">
        <span class="checkbook-status {% if bank_account.is_active %}status-active{% else %}status-inactive{% endif %}">
          {% if bank_account.is_active %}فعال{% else %}غیرفعال{% endif %}
        </span>
      </span>
    </div>
    <div class="info-item">
      <span class="info-label">ایجاد شده توسط:</span>
      <span class="info-value">{{ bank_account.created_by.get_full_name|default:bank_account.created_by.username }}</span>
    </div>
    <div class="info-item">
      <span class="info-label">تاریخ ایجاد:</span>
      <span class="info-value">{{ bank_account.created_at|jalali_date }}</span>
    </div>
  </div>
  
  <div class="balance-section">
    <div class="balance-amount">
      {{ bank_account.current_balance|persian_number_format }} ریال
    </div>
    <div style="font-size: 14px; color: #666;">
      موجودی فعلی حساب
    </div>
  </div>
  
  <div class="checkbooks-section">
    <div class="section-title">دسته‌های چک</div>
    
    {% if bank_account.checkbooks.all %}
      <div class="checkbooks-table">
        <div class="checkbooks-header">
          <div class="checkbook-col">سریال دسته چک</div>
          <div class="checkbook-col">شماره شروع</div>
          <div class="checkbook-col">شماره پایان</div>
          <div class="checkbook-col">تعداد کل</div>
          <div class="checkbook-col">تعداد خرجی</div>
          <div class="checkbook-col">تعداد مانده</div>
          <div class="checkbook-col">وضعیت</div>
          <div class="checkbook-col">عملیات</div>
        </div>
        
        {% for checkbook in bank_account.checkbooks.all %}
          <div class="checkbook-row">
            <div class="checkbook-col">
              <span class="checkbook-serial">{{ checkbook.serial }}</span>
            </div>
            <div class="checkbook-col">
              <span class="checkbook-number">{{ checkbook.start_number }}</span>
            </div>
            <div class="checkbook-col">
              <span class="checkbook-number">{{ checkbook.end_number }}</span>
            </div>
            <div class="checkbook-col">
              <span class="checkbook-count total-count">{{ checkbook.total_checks }}</span>
            </div>
            <div class="checkbook-col">
              <span class="checkbook-count used-count">{{ checkbook.used_checks }}</span>
            </div>
            <div class="checkbook-col">
              <span class="checkbook-count remaining-count">{{ checkbook.remaining_checks }}</span>
            </div>
            <div class="checkbook-col">
              <span class="checkbook-status {% if checkbook.is_active %}status-active{% else %}status-inactive{% endif %}">
                {% if checkbook.is_active %}فعال{% else %}غیرفعال{% endif %}
              </span>
            </div>
            <div class="checkbook-col">
              <div class="checkbook-actions">
                <a href="{% url 'products:checkbook_detail' checkbook.id %}" class="btn btn-sm btn-info" title="جزئیات">
                  <i class="bi bi-eye"></i>
                </a>
                <a href="{% url 'products:checkbook_edit' checkbook.id %}" class="btn btn-sm btn-warning" title="ویرایش">
                  <i class="bi bi-pencil"></i>
                </a>
                <a href="{% url 'products:issued_checks_report' checkbook.id %}" class="btn btn-sm btn-success" title="گزارش چک‌های خرجی">
                  <i class="bi bi-file-earmark-text"></i>
                </a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-message">
        <p>هیچ دسته چکی برای این حساب تعریف نشده است.</p>
      </div>
    {% endif %}
    
    <a href="{% url 'products:bank_account_edit' bank_account.id %}" class="add-checkbook-btn">
      <i class="bi bi-plus-circle"></i>
      افزودن دسته چک جدید
    </a>
  </div>

  <!-- بخش چک‌های واگذاری -->
  <div class="deposited-checks-section">
    <div class="section-title">چک‌های واگذاری</div>
    
    <div class="deposited-checks-actions">
      <a href="{% url 'products:available_checks_for_deposit' bank_account.id %}" class="list-checks-btn">
        <i class="bi bi-list-check"></i>
        لیست چک‌ها
      </a>
    </div>

    <!-- باکس جستجوی پیشرفته -->
  <div class="advanced-search">
    <button type="button" class="search-toggle" onclick="toggleAdvancedSearch()">
      <i class="bi bi-search"></i>
      جستجوی پیشرفته
    </button>
    
    <div class="search-fields" id="search-fields">

      <div class="search-field">
        <label for="search-endorsement">پشت نمره:</label>
        <input type="text" id="search-endorsement" placeholder="پشت نمره را وارد کنید">
      </div> 

      <div class="search-field">
        <label for="search-serial">سریال چک:</label>
        <input type="text" id="search-serial" placeholder="سریال چک را وارد کنید">
      </div>
        
      <div class="search-field">
        <label for="search-sayadi">شناسه صیادی:</label>
        <input type="text" id="search-sayadi" placeholder="شناسه صیادی را وارد کنید">
      </div>
      
      <div class="search-field">
        <label for="search-owner">صاحب حساب:</label>
        <input type="text" id="search-owner" placeholder="نام صاحب حساب را وارد کنید">
      </div>
      
      <div class="search-field">
        <label for="search-amount-min">مبلغ از:</label>
        <input type="number" id="search-amount-min" placeholder="حداقل مبلغ">
      </div>
      
      <div class="search-field">
        <label for="search-amount-max">مبلغ تا:</label>
        <input type="number" id="search-amount-max" placeholder="حداکثر مبلغ">
      </div>
      
      <div class="search-field">
        <label for="search-due-date-from">تاریخ سررسید از (شمسی):</label>
        <input type="text" id="search-due-date-from" class="date-input persian-datepicker" placeholder="1403/05/15" readonly>
      </div>
      
      <div class="search-field">
        <label for="search-due-date-to">تاریخ سررسید تا (شمسی):</label>
        <input type="text" id="search-due-date-to" class="date-input persian-datepicker" placeholder="1403/06/15" readonly>
      </div>
      
      <div class="search-field">
        <label for="search-customer">مشتری:</label>
        <input type="text" id="search-customer" placeholder="نام مشتری را وارد کنید">
      </div>
    </div>
    
    <div class="search-actions" id="search-actions" style="display: none;">
      <button type="button" class="search-btn" onclick="applyAdvancedSearch()">
        <i class="bi bi-search"></i>
        اعمال فیلتر
      </button>
      <button type="button" class="clear-btn" onclick="clearAdvancedSearch()">
        <i class="bi bi-x-circle"></i>
        پاک کردن
      </button>
    </div>
  </div>

    {% if deposited_checks %}
      <div class="deposited-checks-table">
        <div class="deposited-checks-header">
          <div class="check-col">پشت نمره</div>
          <div class="check-col">سریال</div>
          <div class="check-col">شناسه صیادی</div>
          <div class="check-col">صاحب حساب</div>
          <div class="check-col">نام مشتری</div>
          <div class="check-col">مبلغ</div>
          <div class="check-col">تاریخ سررسید</div>
          <div class="check-col">وضعیت</div>
          <div class="check-col">تاریخ واگذاری</div>
          <div class="check-col">عملیات</div>
        </div>
        
        {% for check in deposited_checks %}
          <div class="deposited-check-row">
            <div class="check-col">
              <span class="check-endorsement">{{ check.endorsement|default:"-" }}</span>
            </div>
            <div class="check-col">
              <span class="check-serial">{{ check.serial|default:"-" }}</span>
            </div>
            <div class="check-col">
              <span class="check-sayadi">{{ check.sayadi_id }}</span>
            </div>
            <div class="check-col">
              <span class="check-owner">{{ check.owner_name }}</span>
            </div>
            <div class="check-col">
              <span class="check-customer">{{ check.customer.get_full_name|default:"-" }}</span>
            </div>
            <div class="check-col">
              <span class="check-amount">{{ check.amount|persian_number_format }} ریال</span>
            </div>
            <div class="check-col">
              <span class="check-due-date">{{ check.due_date|jalali_date }}</span>
            </div>
            <div class="check-col">
              <span class="check-status status-deposited">{{ check.get_status_display }}</span>
            </div>
            <div class="check-col">
              <span class="check-deposit-date">{{ check.updated_at|jalali_date }}</span>
            </div>
            <div class="check-col">
              <div class="check-operations">
                {% if check.status == 'DEPOSITED' %}
                  <button type="button" class="operation-btn clear-btn-op" 
                          onclick="clearCheck({{ check.id }}, '{{ check.sayadi_id }}', {{ check.amount }})"
                          title="وصول چک">
                    <i class="bi bi-check-circle"></i>
                  </button>
                  <button type="button" class="operation-btn bounce-btn-op" 
                          onclick="bounceCheck({{ check.id }}, '{{ check.sayadi_id }}')"
                          title="برگشت چک">
                    <i class="bi bi-x-circle"></i>
                  </button>
                {% elif check.status == 'CLEARED' %}
                  <span class="status-badge cleared">وصول شده</span>
                {% elif check.status == 'BOUNCED' %}
                  <span class="status-badge bounced">برگشت خورده</span>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-message">
        <p>هیچ چک واگذار شده‌ای برای این حساب وجود ندارد.</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Persian DatePicker with multiple fallbacks -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

<!-- Fallback to alternative CDN -->
<script>
$(document).ready(function() {
    console.log('DOM Ready - Initializing DatePickers...');
    
    function initializeDatePickers() {
        $('.persian-datepicker').each(function() {
            const $input = $(this);
            console.log('Initializing datepicker for:', this.id);
            
            // Method 1: Try persianDatepicker
            if (typeof $.fn.persianDatepicker !== 'undefined') {
                console.log('Using persianDatepicker method');
                try {
                    $input.persianDatepicker({
                        format: 'YYYY/MM/DD',
                        initialValue: false,
                        autoClose: true,
                        persianDigit: true,
                        calendar: {
                            persian: {
                                locale: 'fa'
                            }
                        }
                    });
                    return;
                } catch (e) {
                    console.error('persianDatepicker failed:', e);
                }
            }
            
            // Method 2: Try pDatepicker  
            if (typeof $.fn.pDatepicker !== 'undefined') {
                console.log('Using pDatepicker method');
                try {
                    $input.pDatepicker({
                        format: 'YYYY/MM/DD',
                        autoClose: true,
                        persianDigit: true,
                        initialValueType: 'persian'
                    });
                    return;
                } catch (e) {
                    console.error('pDatepicker failed:', e);
                }
            }
            
            // Method 3: Manual input with validation and simple calendar
            console.log('Using manual input method with simple calendar');
            $input.attr('placeholder', 'کلیک کنید یا تاریخ وارد کنید')
                  .removeClass('readonly')
                  .css('cursor', 'pointer')
                  .on('input', function() {
                      let value = this.value;
                      // Format as YYYY/MM/DD automatically
                      value = value.replace(/[^\d]/g, '');
                      if (value.length >= 4) {
                          value = value.substring(0, 4) + '/' + value.substring(4);
                      }
                      if (value.length >= 7) {
                          value = value.substring(0, 7) + '/' + value.substring(7, 9);
                      }
                      this.value = value;
                  })
                  .on('click focus', function() {
                      showSimpleCalendar(this);
                  })
                  .on('blur', function() {
                      // Validate date format
                      const datePattern = /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/;
                      if (this.value && !datePattern.test(this.value)) {
                          $(this).css('border-color', '#dc3545');
                          $(this).attr('title', 'فرمت تاریخ: YYYY/MM/DD');
                      } else {
                          $(this).css('border-color', '#28a745');
                          $(this).removeAttr('title');
                      }
                      hideSimpleCalendar();
                  });
        });
    }
    
    // Try multiple times to ensure initialization
    setTimeout(initializeDatePickers, 100);
    setTimeout(initializeDatePickers, 500);
    setTimeout(initializeDatePickers, 1000);
    
    // Add event listeners to prevent form submission
    $(document).on('click', '#apply-search-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        applyAdvancedSearch();
        return false;
    });
    
    $(document).on('click', '#clear-search-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        clearAdvancedSearch();
        return false;
    });
    
    // Prevent form submission on Enter key
    $('.search-field input').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            applyAdvancedSearch();
            return false;
        }
    });
    
    // Load alternative datepicker if primary fails
    setTimeout(function() {
        if (!$('.persian-datepicker').hasClass('hasDatepicker') && 
            typeof $.fn.persianDatepicker === 'undefined' && 
            typeof $.fn.pDatepicker === 'undefined') {
            console.log('Loading alternative datepicker...');
            
            // Load alternative datepicker
            $('<link>')
                .attr({
                    type: 'text/css',
                    rel: 'stylesheet',
                    href: 'https://unpkg.com/persian-datepicker@latest/dist/css/persian-datepicker.min.css'
                })
                .appendTo('head');
                
            $.getScript('https://unpkg.com/persian-datepicker@latest/dist/js/persian-datepicker.min.js')
                .done(function() {
                    console.log('Alternative datepicker loaded');
                    setTimeout(initializeDatePickers, 100);
                });
        }
    }, 2000);
});

// Simple Calendar Functions
let currentCalendarInput = null;

function showSimpleCalendar(input) {
    hideSimpleCalendar(); // Hide any existing calendar
    currentCalendarInput = input;
    
    const calendar = createSimpleCalendar();
    document.body.appendChild(calendar);
    
    // Position calendar near input
    const rect = input.getBoundingClientRect();
    calendar.style.position = 'fixed';
    calendar.style.top = (rect.bottom + window.scrollY + 5) + 'px';
    calendar.style.left = (rect.left + window.scrollX) + 'px';
    calendar.style.zIndex = '9999';
}

function hideSimpleCalendar() {
    const existingCalendar = document.getElementById('simple-calendar');
    if (existingCalendar) {
        existingCalendar.remove();
    }
    currentCalendarInput = null;
}

function createSimpleCalendar() {
    const calendar = document.createElement('div');
    calendar.id = 'simple-calendar';
    calendar.className = 'simple-calendar';
    
    // Get current Persian date
    const today = new Date();
    const currentPersianYear = 1403; // Default year
    const currentPersianMonth = 1;   // Default month
    
    calendar.innerHTML = `
        <div class="calendar-header">
            <button type="button" onclick="selectTodayDate()">امروز</button>
            <button type="button" onclick="hideSimpleCalendar()">×</button>
        </div>
        <div class="calendar-quick-dates">
            <button type="button" onclick="selectQuickDate('${currentPersianYear}/01/01')">ابتدای سال</button>
            <button type="button" onclick="selectQuickDate('${currentPersianYear}/12/29')">پایان سال</button>
        </div>
        <div class="calendar-input-section">
            <input type="text" placeholder="1403/01/15" class="calendar-manual-input" 
                   onkeypress="if(event.key==='Enter') selectManualDate()">
            <button type="button" onclick="selectManualDate()">انتخاب</button>
        </div>
    `;
    
    // Add CSS for calendar
    const style = document.createElement('style');
    style.textContent = `
        .simple-calendar {
            background: white;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            min-width: 250px;
            font-family: 'b homa', Tahoma, sans-serif;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .calendar-header button {
            padding: 5px 10px;
            border: 1px solid #17a2b8;
            background: #17a2b8;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        .calendar-quick-dates {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .calendar-quick-dates button {
            padding: 5px 8px;
            border: 1px solid #28a745;
            background: #28a745;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .calendar-input-section {
            display: flex;
            gap: 5px;
        }
        .calendar-manual-input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .calendar-input-section button {
            padding: 5px 10px;
            border: 1px solid #007bff;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
    `;
    
    if (!document.getElementById('simple-calendar-style')) {
        style.id = 'simple-calendar-style';
        document.head.appendChild(style);
    }
    
    return calendar;
}

function selectTodayDate() {
    if (currentCalendarInput) {
        // Set today's Persian date (approximate)
        const today = new Date();
        const persianYear = 1403; // You can calculate this properly
        const persianMonth = Math.ceil((today.getMonth() + 1) * 0.8); // Approximate
        const persianDay = Math.ceil(today.getDate() * 0.9); // Approximate
        
        currentCalendarInput.value = `${persianYear}/${persianMonth.toString().padStart(2, '0')}/${persianDay.toString().padStart(2, '0')}`;
        $(currentCalendarInput).trigger('blur');
        hideSimpleCalendar();
    }
}

function selectQuickDate(date) {
    if (currentCalendarInput) {
        currentCalendarInput.value = date;
        $(currentCalendarInput).trigger('blur');
        hideSimpleCalendar();
    }
}

function selectManualDate() {
    const manualInput = document.querySelector('.calendar-manual-input');
    if (currentCalendarInput && manualInput && manualInput.value) {
        currentCalendarInput.value = manualInput.value;
        $(currentCalendarInput).trigger('blur');
        hideSimpleCalendar();
    }
}

// Close calendar when clicking outside
$(document).on('click', function(e) {
    if (!$(e.target).closest('.simple-calendar, .persian-datepicker').length) {
        hideSimpleCalendar();
    }
});

// Check Operations Functions
function clearCheck(checkId, sayadiId, amount) {
    if (confirm(`آیا از وصول چک با شناسه صیادی ${sayadiId} اطمینان دارید؟\nمبلغ ${amount.toLocaleString()} ریال به حساب بانکی اضافه خواهد شد.`)) {
        // Show loading
        const btn = event.target.closest('.clear-btn-op');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        btn.disabled = true;
        
        fetch(`/accounting/received-checks/${checkId}/clear/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'action': 'clear'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI
                const row = btn.closest('.deposited-check-row');
                const operationsCell = row.querySelector('.check-operations');
                operationsCell.innerHTML = '<span class="status-badge cleared">وصول شده</span>';
                
                // Update status cell
                const statusCell = row.querySelector('.check-status');
                statusCell.innerHTML = 'وصول شده';
                statusCell.className = 'check-status status-cleared';
                
                // Show success message
                showMessage('چک با موفقیت وصول شد و مبلغ به حساب بانکی اضافه گردید.', 'success');
                
                // Refresh page after 2 seconds to show updated balance
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                btn.innerHTML = originalContent;
                btn.disabled = false;
                showMessage('خطا در وصول چک: ' + (data.error || 'خطای نامشخص'), 'error');
            }
        })
        .catch(error => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
            showMessage('خطا در ارتباط با سرور', 'error');
            console.error('Error:', error);
        });
    }
}

function bounceCheck(checkId, sayadiId) {
    if (confirm(`آیا از برگشت چک با شناسه صیادی ${sayadiId} اطمینان دارید؟\nچک به چک‌های نزد صندوق منتقل خواهد شد.`)) {
        // Show loading
        const btn = event.target.closest('.bounce-btn-op');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        btn.disabled = true;
        
        fetch(`/accounting/received-checks/${checkId}/bounce/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'action': 'bounce'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove row from deposited checks
                const row = btn.closest('.deposited-check-row');
                row.style.transition = 'opacity 0.5s';
                row.style.opacity = '0';
                
                setTimeout(() => {
                    row.remove();
                    
                    // Check if any checks remain
                    const remainingChecks = document.querySelectorAll('.deposited-check-row');
                    if (remainingChecks.length === 0) {
                        const tableContainer = document.querySelector('.deposited-checks-table');
                        tableContainer.innerHTML = '<div class="empty-message"><p>هیچ چک واگذار شده‌ای برای این حساب وجود ندارد.</p></div>';
                    }
                }, 500);
                
                showMessage('چک با موفقیت برگشت خورد و به چک‌های نزد صندوق منتقل شد.', 'success');
            } else {
                btn.innerHTML = originalContent;
                btn.disabled = false;
                showMessage('خطا در برگشت چک: ' + (data.error || 'خطای نامشخص'), 'error');
            }
        })
        .catch(error => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
            showMessage('خطا در ارتباط با سرور', 'error');
            console.error('Error:', error);
        });
    }
}

function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        font-weight: bold;
        max-width: 400px;
        ${type === 'success' ? 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'}
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }, 5000);
}

// Add CSRF token if not exists
if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = '{{ csrf_token }}';
    document.body.appendChild(csrfInput);
}

// تابع مقایسه تاریخ‌های شمسی
function comparePersianDate(dateText, compareDate, operator) {
    if (!dateText || !compareDate) return true;
    
    // تبدیل اعداد فارسی به انگلیسی
    const convertPersianNumbers = (str) => {
        return str.replace(/[۰-۹]/g, function(w) {
            return String.fromCharCode(w.charCodeAt(0) - 1728);
        });
    };
    
    const cleanDateText = convertPersianNumbers(dateText.trim());
    const cleanCompareDate = convertPersianNumbers(compareDate.trim());
    
    // استخراج سال، ماه، روز
    const dateMatch = cleanDateText.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
    const compareMatch = cleanCompareDate.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
    
    if (!dateMatch || !compareMatch) return true;
    
    const date1 = parseInt(dateMatch[1]) * 10000 + parseInt(dateMatch[2]) * 100 + parseInt(dateMatch[3]);
    const date2 = parseInt(compareMatch[1]) * 10000 + parseInt(compareMatch[2]) * 100 + parseInt(compareMatch[3]);
    
    switch (operator) {
        case '>=': return date1 >= date2;
        case '<=': return date1 <= date2;
        case '>': return date1 > date2;
        case '<': return date1 < date2;
        case '==': return date1 === date2;
        default: return true;
    }
}

// Advanced Search Functions
function toggleAdvancedSearch() {
    const searchFields = document.getElementById('search-fields');
    const searchActions = document.getElementById('search-actions');
    const isVisible = searchFields.classList.contains('show');
    
    if (isVisible) {
        searchFields.classList.remove('show');
        searchActions.style.display = 'none';
    } else {
        searchFields.classList.add('show');
        searchActions.style.display = 'flex';
    }
}

function applyAdvancedSearch() {
    const searchTerms = {
        sayadi: document.getElementById('search-sayadi').value.toLowerCase(),
        owner: document.getElementById('search-owner').value.toLowerCase(),
        serial: document.getElementById('search-serial').value.toLowerCase(),
        endorsement: document.getElementById('search-endorsement').value.toLowerCase(),
        amountMin: parseFloat(document.getElementById('search-amount-min').value) || 0,
        amountMax: parseFloat(document.getElementById('search-amount-max').value) || Infinity,
        dueDateFrom: document.getElementById('search-due-date-from').value.trim(),
        dueDateTo: document.getElementById('search-due-date-to').value.trim(),
        customer: document.getElementById('search-customer').value.toLowerCase()
    };
    
    const checkRows = document.querySelectorAll('.deposited-check-row');
    let visibleCount = 0;
    
    checkRows.forEach(row => {
        const sayadi = row.querySelector('.check-sayadi').textContent.toLowerCase();
        const owner = row.querySelector('.check-owner').textContent.toLowerCase();
        const serial = row.querySelector('.check-serial').textContent.toLowerCase();
        const endorsement = row.querySelector('.check-endorsement').textContent.toLowerCase();
        const customer = row.querySelector('.check-customer').textContent.toLowerCase();
        const amountText = row.querySelector('.check-amount').textContent;
        
        // بهبود استخراج مبلغ - حذف تمام کاراکترهای غیر عددی و تبدیل اعداد فارسی
        const cleanAmount = amountText.replace(/[^\d۰-۹]/g, '')
                                     .replace(/[۰-۹]/g, function(w) {
                                         return String.fromCharCode(w.charCodeAt(0) - 1728);
                                     });
        const amount = parseFloat(cleanAmount) || 0;
        
        // استخراج تاریخ شمسی (فرمت: 1403/05/28)
        const dueDateText = row.querySelector('.check-due-date').textContent.trim();
        
        let matches = true;
        
        // بررسی فیلدهای متنی
        if (searchTerms.sayadi && !sayadi.includes(searchTerms.sayadi)) matches = false;
        if (searchTerms.owner && !owner.includes(searchTerms.owner)) matches = false;
        if (searchTerms.serial && !serial.includes(searchTerms.serial)) matches = false;
        if (searchTerms.endorsement && !endorsement.includes(searchTerms.endorsement)) matches = false;
        if (searchTerms.customer && !customer.includes(searchTerms.customer)) matches = false;
        
        // بررسی محدوده مبلغ
        if (amount < searchTerms.amountMin || amount > searchTerms.amountMax) matches = false;
        
        // بررسی محدوده تاریخ شمسی
        if (searchTerms.dueDateFrom && !comparePersianDate(dueDateText, searchTerms.dueDateFrom, '>=')) matches = false;
        if (searchTerms.dueDateTo && !comparePersianDate(dueDateText, searchTerms.dueDateTo, '<=')) matches = false;
        
        // نمایش/مخفی کردن ردیف
        if (matches) {
            row.style.display = 'grid';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Show result message
    const resultMessage = document.createElement('div');
    resultMessage.style.cssText = `
        background: #d1ecf1;
        color: #0c5460;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        text-align: center;
        font-weight: bold;
    `;
    resultMessage.textContent = `${visibleCount} چک پیدا شد`;
    
    // Remove existing result message
    const existingMessage = document.querySelector('.search-result-message');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    resultMessage.className = 'search-result-message';
    document.querySelector('.deposited-checks-table').insertBefore(resultMessage, document.querySelector('.deposited-checks-header'));
    
    // Auto remove message after 3 seconds
    setTimeout(() => {
        if (resultMessage) {
            resultMessage.remove();
        }
    }, 3000);
}

function clearAdvancedSearch() {
    // Clear all search fields
    document.getElementById('search-sayadi').value = '';
    document.getElementById('search-owner').value = '';
    document.getElementById('search-serial').value = '';
    document.getElementById('search-endorsement').value = '';
    document.getElementById('search-amount-min').value = '';
    document.getElementById('search-amount-max').value = '';
    document.getElementById('search-due-date-from').value = '';
    document.getElementById('search-due-date-to').value = '';
    document.getElementById('search-customer').value = '';
    
    // Show all rows
    const checkRows = document.querySelectorAll('.deposited-check-row');
    checkRows.forEach(row => {
        row.style.display = 'grid';
    });
    
    // Remove result message
    const existingMessage = document.querySelector('.search-result-message');
    if (existingMessage) {
        existingMessage.remove();
    }
}
</script>
{% endblock %} 