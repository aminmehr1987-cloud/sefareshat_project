{% extends 'products/base.html' %}
{% load custom_filters %}
{% load shipment_extras %}

{% block title %} مدیریت سفارشات {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<!-- Persian Datepicker -->
<link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
<style>

  body {
    font-family: 'BHoma', sans-serif;
    background-color: transparent; /* اجازه می‌دهیم بک‌گراند base.html نمایش داده شود */
    direction: rtl;
    margin: 0;
}

  /* Advanced Search Styles */
  .advanced-search {
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.1);
  }

  .search-toggle {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .search-toggle:hover {
    background: #0056b3;
  }

  .search-fields {
    display: none;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
    padding: 15px;
    background: rgba(255,255,255,0.02);
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.05);
  }

  .search-fields.show {
    display: grid;
  }

  .search-field {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .search-field label {
    font-size: 12px;
    font-weight: bold;
    color: #333;
  }

  .search-field input,
  .search-field select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    background: white;
  }

  .search-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    justify-content: center;
  }

  .search-btn,
  .clear-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .search-btn {
    background: #28a745;
    color: white;
  }

  .search-btn:hover {
    background: #218838;
  }

  .clear-btn {
    background: #dc3545;
    color: white;
    text-decoration: none;
  }

  .clear-btn:hover {
    background: #c82333;
  }


  /* Tiles Container Styles */
  .tiles-container {
    display: flex;
    justify-content: center; /* Center items when they wrap */
    margin: 20px 0;
    gap: 15px;
    direction: rtl;
    flex-wrap: wrap; /* Allow tiles to wrap to the next line */
  }
  .tile-card {
    flex: 1 1 18%; /* 5 tiles per row */
    min-width: 160px;
    max-width: 19%;
    box-sizing: border-box;
    background: linear-gradient(135deg, #4e9af1, #71b7ff);
    color: white;
    padding: 15px;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .tile-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(30, 136, 229, 0.6);
  }
  .tile-card.active {
    background: linear-gradient(135deg, #2c3e50, #34495e);
  }
  .tile-icon {
    width: 36px; /* Slightly smaller icon */
    height: 36px;
    flex-shrink: 0;
  }
  .tile-title {
    font-size: 17px; /* Base font size */
    font-weight: 600;
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .tile-count {
    background: rgba(255, 255, 255, 0.25);
    padding: 4px 10px; /* Slightly smaller padding */
    border-radius: 20px;
    font-weight: 700;
    font-size: 15px; /* Base font size for count */
    min-width: 30px; /* Ensure it doesn't get too small */
    text-align: center;
    flex-shrink: 0; /* Prevent it from shrinking */
  }

  /* Specific Tile Colors (unchanged) */
  .tile-all { background: linear-gradient(135deg, #4e9af1, #71b7ff); }
  .tile-pending { background: linear-gradient(135deg, #f4b400, #f7c242); }
  .tile-warehouse { background: linear-gradient(135deg, #00bfa5, #26c6da); }
  .tile-ready { background: linear-gradient(135deg, #ab47bc, #ce93d8); }
  .tile-finalized { background: linear-gradient(135deg, #66bb6a, #a5d6a7); }
  .tile-backordered { background: linear-gradient(135deg, #ef5350, #ef9a9a); }
  .tile-supplied { background: linear-gradient(135deg, #00b894, #55efc4); }
  .tile-backorder-ready { background: linear-gradient(135deg, #fdcb6e, #e17055); }
  .tile-shipped { background: linear-gradient(135deg, #28a745, #4cae4c); }

  /* Tab Content and Table Styles (unchanged from previous version, but included for completeness) */
  .tabcontent {
    display: none;
    background: rgba(255, 255, 255, 0.219);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    margin-top: 20px;
    min-height: 300px;
    overflow-x: auto; /* Add horizontal scroll for mobile */
  }
  .tabcontent.active {
    display: block;
  }
  .orders-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    min-width: 600px; /* Ensure minimum width for readability */
  }
  .orders-table th, .orders-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
    white-space: nowrap; /* Prevent text wrapping */
  }
  .orders-table th {
    background-color: #f0f0f0;
    font-weight: bold;
  }
  .orders-table tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  .orders-table tr:hover {
    background-color: #e8f4fd;
  }
  .details-content-row {
    display: none;
  }
  .details-content-row.active {
    display: table-row;
  }
  .details-content-row td {
    padding: 10px;
    
  }
  .details-content-row td > * {
    max-width: 100%;
    
  }
  .items-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin: 10px 0;
    background-color: #f0f8ff;
    border: 1px solid #ccc;
    min-width: 500px; /* Ensure minimum width for readability */
  }
  .items-table th, .items-table td {
    border: 1px solid #cce;
    padding: 8px;
    text-align: center;
    white-space: nowrap; /* Prevent text wrapping */
  }
  .items-table th {
      background-color: #e6f7ff;
  }
  .action-button {
    padding: 8px 12px;
    border: 2px solid;
    border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    margin: 0 5px;
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    background-color: white;
    color: #333;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .action-button i {
    font-size: 16px;
  }
  
  .details-button {
    border-color: #4e9af1;
    color: #4e9af1;
  }
  
  .details-button:hover {
    background-color: #4e9af1;
    color: white;
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(78, 154, 241, 0.3);
  }
  
  .edit-button {
    border-color: #ff9800;
    color: #ff9800;
  }
  
  .edit-button:hover {
    background-color: #ff9800;
    color: white;
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
  }
  
  .next-stage-button {
    border-color: #66bb6a;
    color: #66bb6a;
  }
  
  .next-stage-button:hover {
    background-color: #66bb6a;
    color: white;
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(102, 187, 106, 0.3);
  }
  
  .print-button {
    padding: 0;
    border: 2px solid #4CAF50;
    border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    margin: 0 5px;
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    background-color: white;
    color: #4CAF50;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-decoration: none;
  }
  
  .print-button i {
    font-size: 14px;
  }
  
  .print-button:hover {
    background-color: #4CAF50;
    color: white;
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
    text-decoration: none;
  }

  .print-order-button {
    border-color: #7e57c2;
    color: #7e57c2;
  }
  
  .print-order-button:hover {
    background-color: #7e57c2;
    color: white;
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(126, 87, 194, 0.3);
  }
  
  .action-button:disabled {
    background-color: #e9ecef;
    color: #6c757d;
    border-color: #6c757d;
    cursor: not-allowed;
    transform: none;
  }
  
  .action-button:disabled:hover {
    background-color: #e9ecef;
    color: #6c757d;
    border-color: #6c757d;
    transform: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .order-status {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    color: white;
    display: inline-block;
    background-color: #4e9af1;
  }
  .status-pending { background-color: #f4b400; }
  .status-warehouse { background-color: #00bfa5; }
  .status-ready { background-color: #ab47bc; }
  .status-delivered { background-color: #66bb6a; }
  .status-backorder { background-color: #ef5350; }
  .status-parent { background-color: #4e9af1; }
  .status-supplied { background-color: #71d2f8; }
  .status-backorder-ready { background-color: #f4b400; }
  .status-shipped { background-color: #28a745; }

  /* Media Queries for Responsiveness */

  /* For screens smaller than 1200px (e.g., tablets in landscape) */
  @media (max-width: 1200px) {
    .tile-card { max-width: 48%; min-width: 140px; }
  }

  /* For screens smaller than 900px (تبلت و موبایل افقی) */
  @media (max-width: 900px) {
    .tile-card { max-width: 100%; min-width: 120px; }
    .tiles-container { gap: 10px; }
  }

  /* For screens smaller than 768px (e.g., tablets in portrait, large phones) */
  @media (max-width: 768px) {
    body {
      padding: 10px;
    }
    .top-header {
      padding: 8px 10px;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    .user-info {
      max-width: 100%;
      font-size: 14px;
    }
    .tile-card {
      max-width: 100%;
      min-width: unset;
      width: 100%;
      font-size: 15px;
      padding: 10px 8px;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }
    .tile-icon {
      width: 26px;
      height: 26px;
    }
    .tile-title {
      font-size: 14px;
    }
    .tile-count {
      font-size: 13px;
      padding: 2px 7px;
    }
    .tabcontent {
      padding: 10px;
      overflow-x: auto;
    }
    .orders-table {
      min-width: 500px;
      font-size: 12px;
    }
    .orders-table th, .orders-table td {
      font-size: 12px;
      padding: 6px;
      white-space: nowrap;
    }
    .action-button {
      padding: 4px 6px;
      font-size: 12px;
      margin: 0 2px;
      width: 28px;
      height: 28px;
      background-color: white;
      border: 2px solid;
    }
    
    .action-button i {
      font-size: 12px;
    }
    
    .details-button {
      border-color: #4e9af1;
      color: #4e9af1;
    }
    
    .edit-button {
      border-color: #ff9800;
      color: #ff9800;
    }
    
    .next-stage-button {
      border-color: #66bb6a;
      color: #66bb6a;
    }
    
    .print-button {
      padding: 0;
      font-size: 12px;
      margin: 0 2px;
      width: 26px;
      height: 26px;
      border: 2px solid #4CAF50;
      background-color: white;
      color: #4CAF50;
    }
    
    .print-button i {
      font-size: 11px;
    }
    .items-table {
      font-size: 11px;
      min-width: 400px;
    }
    .items-table th, .items-table td {
      padding: 4px;
      white-space: nowrap;
    }
    .tiles-container {
      gap: 7px;
    }
  }

  /* For very small screens (e.g., mobile phones) */
  @media (max-width: 480px) {
    body {
      padding: 4px;
    }
    h1 {
      font-size: 18px;
    }
    h2 {
      font-size: 15px;
    }
    .tile-card {
      min-width: unset;
      width: 100%;
      max-width: 100%;
      font-size: 13px;
      padding: 7px 4px;
      gap: 4px;
    }
    .tile-title {
      font-size: 12px;
    }
    .tile-count {
      font-size: 11px;
      padding: 1px 5px;
    }
    .tile-icon {
      width: 18px;
      height: 18px;
    }
    .user-info, .logout-button {
      font-size: 12px;
    }
    .logout-button {
      padding: 4px 8px;
    }
    .tiles-container {
      gap: 4px;
    }
    .tabcontent {
      padding: 5px;
      overflow-x: auto;
    }
    .orders-table {
      min-width: 400px;
      font-size: 11px;
    }
    .orders-table th, .orders-table td {
      font-size: 11px;
      padding: 4px;
      white-space: nowrap;
    }
    .items-table {
      font-size: 10px;
      min-width: 350px;
    }
    .items-table th, .items-table td {
      padding: 3px;
      white-space: nowrap;
    }
    .action-button {
      padding: 2px 4px;
      font-size: 10px;
      margin: 0 1px;
      width: 24px;
      height: 24px;
      background-color: white;
      border: 2px solid;
    }
    
    .action-button i {
      font-size: 10px;
    }
    
    .details-button {
      border-color: #4e9af1;
      color: #4e9af1;
    }
    
    .edit-button {
      border-color: #ff9800;
      color: #ff9800;
    }
    
    .next-stage-button {
      border-color: #66bb6a;
      color: #66bb6a;
    }
    
    .print-button {
      padding: 0;
      font-size: 10px;
      margin: 0 1px;
      width: 22px;
      height: 22px;
      border: 2px solid #4CAF50;
      background-color: white;
      color: #4CAF50;
    }
    
    .print-button i {
      font-size: 9px;
    }
  }

  .status-history {
    margin: 10px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    border: 1px solid #e9ecef;
  }

  .status-history-title {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .status-timeline {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .status-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px dashed #dee2e6;
  }

  .status-item:last-child {
    border-bottom: none;
  }

  .courier-input {
    width: 80%;
    padding: 4px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: inherit;
    font-size: 13px;
    margin: 0 auto;
    display: block;
  }
  
  .courier-input:focus {
    border-color: #4e9af1;
    outline: none;
  }
  
  .next-stage-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .items-table td:last-child {
    width: 140px;
    min-width: 140px;
    max-width: 140px;
  }


  .allocated-qty-input {
    border: 2px solid #36c936;
    border-radius: 5px;
    padding: 4px 6px;
    font-size: 12px;
    background: #f8fdfa;
    transition: border 0.2s, box-shadow 0.2s;
  }
  .allocated-qty-input:focus {
    border-color: #f1a900;
    box-shadow: 0 0 4px #f1a90055;
    background: #fffbe6;
  }

  /* Table wrapper for mobile scrolling */
  .table-wrapper {
    overflow-x: auto;
    max-width: 100%;
    margin: 10px 0;
  }
  
  .table-wrapper table {
    margin: 0;
  }

  /* New styles for mobile responsiveness */
  @media (max-width: 768px) {
    .details-content-row td {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
  }
</style>
{% endblock %}

{% block content %}

<h1> </h1>



<div class="tiles-container" style="flex-wrap: wrap; gap: 15px;">
  <div class="tile-card tile-all" onclick="openTabByName('All', this)">
    <svg class="tile-icon" fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm2 4h2v-2H5v2zm0-8h2V7H5v2zm4 8h12v-2H9v2zm0-4h12v-2H9v2zm0-6v2h12V7H9z"/></svg>
    <span class="tile-title">خلاصه سفارشات</span>
    <span class="tile-count">{{ all_requests.count }}</span>
  </div>
  <div class="tile-card tile-pending" onclick="openTabByName('Pending', this)">
    <svg class="tile-icon" fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 15h-2v-2h2zm0-4h-2V7h2z"/></svg>
    <span class="tile-title">در انتظار تأیید</span>
    <span class="tile-count">{{ pending_requests.count }}</span>
  </div>
  <div class="tile-card tile-warehouse" onclick="openTabByName('Warehouse', this)">
    <svg class="tile-icon" fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 6v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6h16zM9 12v4h2v-4zm6 0v4h2v-4z"/></svg>
    <span class="tile-title">   سفارشات ارسالی به انبار</span>
    <span class="tile-count">{{ warehouse_requests.count }}</span>
  </div>
  <div class="tile-card tile-ready" onclick="openTabByName('Ready', this)">
    <svg class="tile-icon" fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 13h14v-2H5zm0 4h14v-2H5zm0-8h14V7H5z"/></svg>
    <span class="tile-title">در انتظار ارسال به مشتری</span>
    <span class="tile-count">{{ ready_requests.count }}</span>
  </div>
  <div class="tile-card tile-backordered" onclick="openTabByName('Backordered', this)">
    <svg class="tile-icon" fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 15h-2v-2h2zm0-4h-2V7h2z"/></svg>
    <span class="tile-title">بک‌اوردرها</span>
    <span class="tile-count">{{ backordered_requests.count }}</span>
  </div>
  <div class="tile-card tile-supplied" onclick="openTabByName('Supplied', this)">
    <svg class="tile-icon" fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 15h-2v-2h2zm0-4h-2V7h2z"/></svg>
    <span class="tile-title">بک اوردرهای ارسال شده به انبار</span>
    <span class="tile-count">{{ supplied_requests.count }}</span>
  </div>
  <div class="tile-card tile-backorder-ready" onclick="openTabByName('BackorderReady', this)">
    <svg class="tile-icon" fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 15h-2v-2h2zm0-4h-2V7h2z"/></svg>
    <span class="tile-title">بک اوردرهای آماده ارسال به مشتری</span>
    <span class="tile-count">{{ backorder_ready_requests.count }}</span>
  </div>

  <div class="tile-card tile-shipped" onclick="openTabByName('Shipped', this)">
    <svg class="tile-icon" fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.16 8.6l-1.43-4.29A2 2 0 0 0 16.83 3H7.17a2 2 0 0 0-1.9 1.31L3.84 8.6A2 2 0 0 0 3 10.13V19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-1h6v1a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-8.87a2 2 0 0 0-.84-1.53zM7.17 5h9.66l1.25 3.75H5.92zM19 19a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1v-2H8v2a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-8.87a1 1 0 0 1 .42-.8l.1-.07h13l.1.07a1 1 0 0 1 .42.8z"/></svg>
    <span class="tile-title">ارسال شده ها</span>
    <span class="tile-count">{{ shipped_shipments.count }}</span>
  </div>
  <div class="tile-card tile-finalized" onclick="openTabByName('Delivered', this)">
    <svg class="tile-icon" fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm-2 15l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>
    <span class="tile-title">نهایی شده</span>
    <span class="tile-count">{{ delivered_shipments.count }}</span>
  </div>
</div>

<!-- Advanced Search Section -->
<div class="advanced-search">
  <button type="button" class="search-toggle" onclick="toggleAdvancedSearch()">
    <i class="bi bi-search"></i>
    جستجوی پیشرفته
  </button>
  
  <form method="get" action="{% url 'products:manager_order_list' %}" id="search-form">
    <div id="search-fields" class="search-fields">
      <div class="search-field">
        <label for="date_from">تاریخ از:</label>
        <input type="text" name="date_from" id="date_from" class="persian-datepicker" placeholder="تاریخ شروع" value="{{ request.GET.date_from }}">
      </div>
      <div class="search-field">
        <label for="date_to">تاریخ تا:</label>
        <input type="text" name="date_to" id="date_to" class="persian-datepicker" placeholder="تاریخ پایان" value="{{ request.GET.date_to }}">
      </div>
      <div class="search-field">
        <label for="order_number">شماره سفارش:</label>
        <input type="text" name="order_number" id="order_number" placeholder="شماره سفارش" value="{{ request.GET.order_number }}">
      </div>
      <div class="search-field">
        <label for="customer_name">نام مشتری:</label>
        <input type="text" name="customer_name" id="customer_name" placeholder="نام مشتری" value="{{ request.GET.customer_name }}">
      </div>
      <div class="search-field">
        <label for="visitor_name">نام ویزیتور:</label>
        <input type="text" name="visitor_name" id="visitor_name" placeholder="نام ویزیتور" value="{{ request.GET.visitor_name }}">
      </div>
      <div class="search-field">
        <label for="status">وضعیت:</label>
        <select name="status" id="status">
          <option value="" {% if not request.GET.status %}selected{% endif %}>همه</option>
          {% for value, display in status_choices %}
            <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ display }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    
    <div id="search-actions" class="search-actions" style="display: none;">
      <button type="submit" class="search-btn">
        <i class="bi bi-search"></i>
        اعمال فیلتر
      </button>
      <a href="{% url 'products:manager_order_list' %}" class="clear-btn">
        <i class="bi bi-x-circle"></i>
        پاک کردن
      </a>
    </div>
  </form>
</div>

<div id="All" class="tabcontent">
<h2>خلاصه کلی سفارشات</h2>
<table class="orders-table" id="all-orders">
  <thead>
    <tr>
      <th>تاریخ</th>
      <th>شماره سفارش</th>
      <th>نام مشتری</th>
      <th>نام ویزیتور</th>
      <th>وضعیت</th>
      <th>عملیات</th>
    </tr>
  </thead>
  <tbody>
    {% for order in all_requests %}
    <tr>
      <td>{{ order.created_at|jformat:"%Y/%m/%d" }}</td>
      <td>{{ order.order_number }}</td>
      <td>{{ order.customer_name }}</td>
      <td>{{ order.visitor_name|get_user_full_name }}</td>
      <td>
        <span class="order-status status-{{ order.status }}">
          {% if order.status == "pending" %}در انتظار تأیید
          {% elif order.status == "cart" %}سبد خرید 
          {% elif order.status == "warehouse" %}ارسال شده به انبار
          {% elif order.status == "ready" %}آماده تحویل
          {% elif order.status == "delivered" %}تحویل داده شده
          {% elif order.status == "parent" %}تفکیک شده به انبارها
          {% elif order.status == "completed" %}نهایی شده
          {% elif order.status == "backorder" %}در انتظار موجودی
          {% elif order.status == "waiting_for_customer_shipment" %}در انتظار ارسال به مشتری
          {% elif order.status == "waiting_for_warehouse_confirmation"%} در انتظار تایید انبار دار
          {% elif order.status == "shipped" %}ارسال شده
          {% else %}نامشخص{% endif %}
        </span>
      </td>
      <td>
        <button class="action-button details-button" onclick="toggleDetails('details-row-all-{{ order.id }}')" title="جزئیات">
          <i class="bi bi-eye-fill"></i>
        </button>
      </td>
    </tr>
    <tr id="details-row-all-{{ order.id }}" class="details-content-row">
      <td colspan="6">
        {% if order.get_sub_orders.exists %}
        <h4>زیرسفارش‌ها:</h4>
        <div class="table-wrapper">
          <table class="items-table">
            <thead>
              <tr>
                <th>شماره زیرسفارش</th>
                <th>انبار</th>
                <th>نوع سفارش</th> <!-- نوع سفارش اضافه شد -->
                <th>وضعیت</th>
                <th>شماره سند</th>
                <th>تعداد بسته</th>
                <th>عملیات</th>
              </tr>
            </thead>
            <tbody>
              {% for sub_order in order.get_sub_orders %}
              <tr>
                <td>{{ sub_order.order_number }}</td>
                <td>
                  {% if sub_order.items.first and sub_order.items.first.warehouse %}
                    {{ sub_order.items.first.warehouse.name }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if sub_order.order_number|slice:":2" == "BO" %}
                    بک‌اوردر
                  {% else %}
                    عادی
                  {% endif %}
                </td>
                <td>
                  <span class="order-status status-{{ sub_order.status }}">{{ sub_order.get_status_display }}</span>
                </td>
                <td>{{ sub_order.document_number|default:"-" }}</td>
                <td>{{ sub_order.package_count|default:"-" }}</td>
                <td>
                  <button onclick="window.location.href='{% url 'products:order_confirmation' %}?order_id={{ sub_order.id }}';" class="action-button print-order-button" title="چاپ">
                      <i class="bi bi-printer-fill"></i>
                  </button>
                  <button class="action-button details-button" onclick="toggleDetails('sub-details-{{ sub_order.id }}')" title="جزئیات">
                    <i class="bi bi-eye-fill"></i>
                  </button>
                </td>
              </tr>
              <tr id="sub-details-{{ sub_order.id }}" class="details-content-row">
                <td colspan="7">
                  <div class="table-wrapper">
                    <table class="items-table">
                      <thead>
                        <tr>
                          <th>کد کالا</th>
                          <th>نام محصول</th>
                          <th>تعداد درخواستی</th>
                          <th>تعداد تخصیص یافته</th>
                          <th>تعداد تحویلی</th>
                          <th>قیمت واحد</th>
                          <th>جمع کل</th>
                          <th>تسویه</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in sub_order.items.all %}
                        <tr>
                          <td>{{ item.product.code }}</td>
                          <td>{{ item.product.name }}</td>
                          <td>{{ item.requested_quantity }}</td>
                          <td>
                            {% if sub_order.status in 'pending,warehouse,parent' %}
                              <span style="color:#f00f0f;">در انتظار تخصیص</span>
                            {% else %}
                              {{ item.allocated_quantity|default:"-" }}
                            {% endif %}
                          </td>    
                          <td>{{ item.delivered_quantity|default:"-" }}</td>
                          <td>{{ item.price|floatformat:0 }} ریال</td>
                          <td>
                            {% if sub_order.status in 'pending,warehouse,parent' %}
                              <span style="color:#ec0c0c;">-</span>
                            {% else %}
                              {{ item.price|multiply:item.delivered_quantity|floatformat:0 }} ریال
                            {% endif %}  
                          </td>
                          <td>{{ item.get_payment_term_display }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                          <td colspan="8">هیچ کالایی ثبت نشده.</td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="table-wrapper">
          <table class="items-table">
            <thead>
              <tr>
                <th>کد کالا</th>
                <th>نام محصول</th>
                <th>تعداد درخواستی</th>
                <th>تعداد تخصیص یافته</th>
                <th>تعداد تحویلی</th>
                <th>قیمت واحد</th>
                <th>جمع کل</th>
                <th>تسویه</th>
              </tr>
            </thead>
            <tbody>
              {% for item in order.items.all %}
              <tr>
                <td>{{ item.product.code|default:"-" }}</td>
                <td>{{ item.product.name|default:"-" }}</td>
                <td>{{ item.requested_quantity }}</td>
                <td>{{ item.allocated_quantity|default:"0" }}</td>
                <td>{{ item.delivered_quantity|default:"-" }}</td>
                <td>{{ item.price|floatformat:0|default:0 }} ریال</td>
                <td>{{ item.price|multiply:item.delivered_quantity|floatformat:0 }} ریال</td>
                <td>{{ item.get_payment_term_display|default:"-" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8">هیچ کالایی ثبت نشده.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="6">هیچ سفارشی یافت نشد.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

<div id="Pending" class="tabcontent">
  <h2>سفارشات در انتظار تأیید</h2>
  <table class="orders-table" id="pending-orders">
    <thead>
      <tr>
        <th>تاریخ</th>
        <th>شماره سفارش</th>
        <th>نام مشتری</th>
      <th>نام ویزیتور</th>
        <th>وضعیت</th>
        <th>عملیات</th>
      </tr>
    </thead>
    <tbody>
      {% for order in pending_requests %}
      <tr>
        <td>{{ order.created_at|jformat:"%Y/%m/%d" }}</td>
        <td>{{ order.order_number }}</td>
        <td>{{ order.customer_name }}</td>
        <td>{{ order.visitor_name|get_user_full_name }}</td>
        <td><span class="order-status status-pending">در انتظار تأیید</span></td>
        <td>
          <button onclick="window.location.href='{% url 'products:order_confirmation' %}?order_id={{ order.id }}';" class="action-button print-order-button" title="چاپ">
              <i class="bi bi-printer-fill"></i>
          </button>
          <button class="action-button details-button" onclick="toggleDetails('details-row-pending-{{ order.id }}')" title="جزئیات">
            <i class="bi bi-eye-fill"></i>
          </button>
          <button class="action-button edit-button" onclick="editOrder('{{ order.id }}')" title="ویرایش">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="action-button next-stage-button" onclick="moveToNext('{{ order.id }}', 'pending')" title="ارسال به انبار">
            <i class="bi bi-arrow-right-circle"></i>
          </button>
        </td>
      </tr>
      <tr id="details-row-pending-{{ order.id }}" class="details-content-row">
        <td colspan="6">
          {% if order.items.all %}
          <div class="table-wrapper">
            <table class="items-table">
              <thead>
                <tr>
                  <th>کد کالا</th>
                  <th>نام محصول</th>
                  <th>تعداد درخواستی</th>
                  <th>قیمت واحد</th>
                  <th>جمع</th>
                  <th>تسویه</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order.items.all %}
                <tr>
                  <td>{{ item.product.code|default:"-" }}</td>
                  <td>{{ item.product.name|default:"-" }}</td>
                  <td>{{ item.requested_quantity }}</td>
                  <td>{{ item.price|floatformat:0|default:0 }} ریال</td>
                  <td>{{ item.total_price|floatformat:0|default:0 }} ریال</td>
                  <td>{{ item.get_payment_term_display|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6">هیچ کالایی یافت نشد.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p>هیچ آیتمی برای این سفارش وجود ندارد.</p>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6">هیچ سفارشی یافت نشد.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="Warehouse" class="tabcontent">
  <h2>تفکیک شده به انبارها</h2>
  <table class="orders-table" id="warehouse-orders">
    <thead>
      <tr>
        <th>تاریخ</th>
        <th>شماره سفارش</th>
        <th>نام مشتری</th>
      <th>نام ویزیتور</th>
        <th>وضعیت</th>
        <th>عملیات</th>
      </tr>
    </thead>
    <tbody>
      {% for order in parent_requests %}
      <tr>
        <td>{{ order.created_at|jformat:"%Y/%m/%d" }}</td>
        <td>{{ order.order_number }}</td>
        <td>{{ order.customer_name }}</td>
        <td>{{ order.visitor_name|get_user_full_name }}</td>
        <td><span class="order-status status-parent">تفکیک شده به انبارها</span></td>
        <td>
          <button class="action-button details-button" onclick="toggleDetails('details-row-warehouse-{{ order.id }}')" title="جزئیات">
            <i class="bi bi-eye-fill"></i>
          </button>
        </td>
      </tr>
      <tr id="details-row-warehouse-{{ order.id }}" class="details-content-row">
        <td colspan="5">
          <h4>زیرسفارش‌ها:</h4>
          <div class="table-wrapper">
            <table class="items-table">
              <thead>
                <tr>
                  <th>شماره سفارش</th>
                  <th>انبار</th>
                  <th>وضعیت</th>
                  <th>شماره سند</th>
                  <th>تعداد بسته</th>
                  <th>عملیات</th>
                </tr>
              </thead>
              <tbody>
                {% for sub_order in order.get_sub_orders %}
                <tr>
                  <td>{{ sub_order.order_number }}</td>
                  <td>{{ sub_order.items.first.warehouse.name }}</td>
                  <td><span class="order-status status-{{ sub_order.status }}">{{ sub_order.get_status_display }}</span></td>
                  <td>{{ sub_order.document_number|default:"-" }}</td>
                  <td>{{ sub_order.package_count }}</td>
                  <td>
                    <button onclick="window.location.href='{% url 'products:order_confirmation' %}?order_id={{ sub_order.id }}';" class="action-button print-order-button" title="چاپ">
                        <i class="bi bi-printer-fill"></i>
                    </button>
                    <button class="action-button details-button" onclick="toggleDetails('sub-details-warehouse-{{ sub_order.id }}')" title="جزئیات">
                      <i class="bi bi-eye-fill"></i>
                    </button>
                  </td>
                </tr>
                <tr id="sub-details-warehouse-{{ sub_order.id }}" class="details-content-row">
                  <td colspan="6">
                    <div class="table-wrapper">
                      <table class="items-table">
                        <thead>
                          <tr>
                            <th>کد کالا</th>
                            <th>نام محصول</th>
                            <th>تعداد درخواستی</th>
                            <th>تعداد تخصیص یافته</th>
                            <th>قیمت واحد</th>
                            <th>جمع کل</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for item in sub_order.items.all %}
                          <tr>
                            <td>{{ item.product.code }}</td>
                            <td>{{ item.product.name }}</td>
                            <td>{{ item.requested_quantity }}</td>
                            <td>
                              {% if sub_order.status in 'pending,warehouse,parent' %}
                                <span style="color:#ff0000;">در انتظار تخصیص</span>
                              {% elif sub_order.parent_order.status == 'waiting_for_customer_shipment' and sub_order.order_number|slice:":2" == "BO" %}
                                {{ item.requested_quantity }}
                              {% else %}
                                {{ item.allocated_quantity|default:"-" }}
                              {% endif %}
                            </td>
                            <td>{{ item.price|floatformat:0|default:0 }} ریال</td>
                            <td>
                              {% if sub_order.status in 'pending,warehouse,parent' %}
                                <span style="color:#fa0000;">-</span>
                              {% elif sub_order.parent_order.status == 'waiting_for_customer_shipment' and sub_order.order_number|slice:":2" == "BO" %}
                                {% widthratio item.requested_quantity 1 item.price %} ریال
                              {% else %}
                                {% widthratio item.allocated_quantity|default:"0" 1 item.price %} ریال
                              {% endif %}
                            </td>
                          </tr>
                          {% empty %}
                          <tr>
                            <td colspan="6">هیچ کالایی یافت نشد.</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5">هیچ سفارشی یافت نشد.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="Ready" class="tabcontent">
  <h2>در انتظار ارسال به مشتری</h2>
  <table class="orders-table" id="ready-orders">
    <thead>
      <tr>
        <th>تاریخ <i class="bi bi-funnel filter-icon" onclick="toggleFilter('date', event)"></i></th>
        <th>شماره سفارش <i class="bi bi-funnel filter-icon" onclick="toggleFilter('order-number', event)"></i></th>
        <th>نام مشتری <i class="bi bi-funnel filter-icon" onclick="toggleFilter('customer-name', event)"></i></th>
      <th>نام ویزیتور</th>
        <th>وضعیت <i class="bi bi-funnel filter-icon" onclick="toggleFilter('status', event)"></i></th>
        <th>عملیات</th>
      </tr>
    </thead>
    <tbody>
      {% for order in ready_requests %}
      <tr>
        <td>{{ order.created_at|jformat:"%Y/%m/%d" }}</td>
        <td>{{ order.order_number }}</td>
        <td>{{ order.customer_name }}</td>
        <td>{{ order.visitor_name|get_user_full_name }}</td>
        <td><span class="order-status status-waiting_for_customer_shipment">در انتظار ارسال به مشتری</span></td>
        <td>
          <button class="action-button details-button" onclick="toggleDetails('details-row-ready-{{ order.id }}')" title="جزئیات">
            <i class="bi bi-eye-fill"></i>
          </button>
          {% if not order.get_sub_orders.exists %}
          <button class="action-button next-stage-button" onclick="moveToNext('{{ order.id }}', 'waiting_for_customer_shipment')" id="send-button-{{ order.id }}" disabled title="ارسال شد">
            <i class="bi bi-send"></i>
          </button>
          {% endif %}
        </td>
      </tr>
      <tr id="details-row-ready-{{ order.id }}" class="details-content-row">
        <td colspan="5">
          {% if order.get_sub_orders.exists %}
          <h4>زیرسفارش‌ها:</h4>
          <div style="margin: 15px 0; text-align: center;">
            <div class="form-group" style="margin-bottom: 10px;">
              <input type="text"
                    class="courier-input"
                    id="courier-{{ order.id }}"
                    onchange="checkParentCourierInput('{{ order.id }}')"
                    placeholder="نام پیک را وارد کنید"
                    style="width: 200px; direction: rtl;">
            </div>
            <button class="action-button next-stage-button"
                    onclick="sendAllSubOrders('{{ order.id }}')"
                    id="send-all-button-{{ order.id }}"
                    disabled title="ارسال همه زیرسفارش‌ها">
              <i class="bi bi-truck"></i>
            </button>
          </div>
          <div class="table-wrapper">
            <table class="items-table" id="sub-orders-{{ order.id }}">
              <thead>
                <tr>
                  <th>شماره سفارش <i class="bi bi-funnel filter-icon" onclick="toggleFilter('sub-order-number', event)"></i></th>
                  <th>انبار <i class="bi bi-funnel filter-icon" onclick="toggleFilter('warehouse', event)"></i></th>
                  <th>وضعیت <i class="bi bi-funnel filter-icon" onclick="toggleFilter('sub-status', event)"></i></th>
                  <th>شماره سند</th>
                  <th>تعداد بسته</th>
                  <th>عملیات</th>
                </tr>
              </thead>
              <tbody>
                {% for sub_order in order.get_sub_orders %}
                {% if sub_order.status != 'backorder' %}
                <tr>
                  <td>{{ sub_order.order_number }}</td>
                  <td>{{ sub_order.items.first.warehouse.name }}</td>
                  <td><span class="order-status status-{{ sub_order.status }}">{{ sub_order.get_status_display }}</span></td>
                  <td>{{ sub_order.document_number|default:"-" }}</td>
                  <td>{{ sub_order.package_count|default:"0" }}</td>
                  <td>
                    <button onclick="window.location.href='{% url 'products:order_confirmation' %}?order_id={{ sub_order.id }}';" class="action-button print-order-button" title="چاپ">
                        <i class="bi bi-printer-fill"></i>
                    </button>
                    <button class="action-button details-button" onclick="toggleDetails('sub-details-ready-{{ sub_order.id }}')" title="جزئیات">
                      <i class="bi bi-eye-fill"></i>
                    </button>
                  </td>
                </tr>
                <tr id="sub-details-ready-{{ sub_order.id }}" class="details-content-row">
                  <td colspan="6">
                    <div class="table-wrapper">
                      <table class="items-table">
                        <thead>
                          <tr>
                            <th>کد کالا</th>
                            <th>نام محصول</th>
                            <th>تعداد درخواستی</th>
                            <th>تعداد تخصیص‌یافته</th>
                            <th>قیمت واحد</th>
                            <th>جمع کل</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for item in sub_order.items.all %}
                          <tr>
                            <td>{{ item.product.code }}</td>
                            <td>{{ item.product.name }}</td>
                            <td>{{ item.requested_quantity }}</td>
                            <td>
                              {% if sub_order.status in 'pending,warehouse,parent' %}
                                <span style="color:#aaa;">-</span>
                              {% elif sub_order.parent_order.status == 'waiting_for_customer_shipment' and sub_order.order_number|slice:":2" == "BO" %}
                                {{ item.requested_quantity }}
                              {% else %}
                                {{ item.allocated_quantity|default:"-" }}
                              {% endif %}
                            </td>
                            <td>{{ item.price|floatformat:0|default:0 }} ریال</td>
                            <td>
                              {% if sub_order.status in 'pending,warehouse,parent' %}
                                <span style="color:#aaa;">-</span>
                              {% elif sub_order.parent_order.status == 'waiting_for_customer_shipment' and sub_order.order_number|slice:":2" == "BO" %}
                                {% widthratio item.requested_quantity 1 item.price %} ریال
                              {% else %}
                                {% widthratio item.allocated_quantity|default:"0" 1 item.price %} ریال
                              {% endif %}
                            </td>
                          </tr>
                          {% empty %}
                          <tr><td colspan="6">هیچ کالایی یافت نشد.</td></tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
                {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          {# اگر سفارش مادر نیست، نمایش به‌صورت کالا به کالا همراه با پیک و بسته #}
          <div class="table-wrapper">
            <table class="items-table">
              <thead>
                <tr>
                  <th>کد کالا</th>
                  <th>نام محصول</th>
                  <th>تعداد درخواستی</th>
                  <th>تعداد تخصیص‌یافته</th>
                  <th>قیمت واحد</th>
                  <th>جمع کل</th>
                  <th>شماره سند</th>
                  <th>تعداد بسته</th>
                  <th>نام پیک</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order.items.all %}
                <tr>
                  <td>{{ item.product.code|default:"-" }}</td>
                  <td>{{ item.product.name|default:"-" }}</td>
                  <td>{{ item.requested_quantity }}</td>
                  <td>{{ item.allocated_quantity }}</td>
                  <td>{{ item.price|floatformat:0|default:0 }} ریال</td>
                  <td>{% widthratio item.quantity 1 item.price %} ریال</td>
                  <td>{{ order.document_number|default:"-" }}</td>
                  <td>{{ order.package_count|default:"-" }}</td>
                  <td>
                    <input type="text"
                          class="courier-input"
                          id="courier-{{ order.id }}"
                          onchange="checkCourierInput('{{ order.id }}')"
                          placeholder="نام پیک را وارد کنید"
                          style="width: 120px; direction: rtl;">
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="9">هیچ کالایی ثبت نشده.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5">هیچ سفارشی یافت نشد.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>



<div id="Supplied" class="tabcontent">
  <h2>بک اوردرهای ارسال شده به انبار</h2>
  <table class="orders-table" id="supplied-orders">
    <thead>
      <tr>
        <th>تاریخ</th>
        <th>شماره سفارش</th>
        <th>نام مشتری</th>
        <th>نام ویزیتور</th>
        <th>وضعیت</th>
        <th>عملیات</th>
      </tr>
    </thead>
    <tbody>
      {% for order in supplied_requests %}
      <tr>
        <td>{{ order.created_at|jformat:"%Y/%m/%d" }}</td>
        <td>{{ order.order_number }}</td>
        <td>{{ order.customer_name }}</td>
        <td>{{ order.visitor_name|get_user_full_name }}</td>
        <td><span class="order-status status-supplied">ارسال شده به انبار</span></td>
        <td>
          <button class="action-button details-button" onclick="toggleDetails('details-row-supplied-{{ order.id }}')" title="جزئیات">
            <i class="bi bi-eye-fill"></i>
          </button>
        </td>
      </tr>
      <tr id="details-row-supplied-{{ order.id }}" class="details-content-row">
        <td colspan="5">
          {% if order.items.all %}
          <div class="table-wrapper">
            <table class="items-table">
              <thead>
                <tr>
                  <th>کد کالا</th>
                  <th>نام محصول</th>
                  <th>تعداد</th>
                  <th>قیمت واحد</th>
                  <th>جمع</th>
                  <th>تسویه</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order.items.all %}
                <tr>
                  <td>{{ item.product.code|default:"-" }}</td>
                  <td>{{ item.product.name|default:"-" }}</td>
                  <td>{{ item.requested_quantity }}</td>
                  <td>{{ item.price|floatformat:0|default:0 }} ریال</td>
                  <td>{{ item.total_price|floatformat:0|default:0 }} ریال</td>
                  <td>{{ item.get_payment_term_display|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6">هیچ کالایی یافت نشد.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p>هیچ آیتمی برای این سفارش وجود ندارد.</p>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5">هیچ سفارشی یافت نشد.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="Backordered" class="tabcontent">
  <h2>بک‌اوردرها</h2>
  <table class="orders-table" id="backordered-orders">
    <thead>
      <tr>
        <th>تاریخ <i class="bi bi-funnel filter-icon" onclick="toggleFilter('date', event)"></i></th>
        <th>شماره سفارش <i class="bi bi-funnel filter-icon" onclick="toggleFilter('order-number', event)"></i></th>
        <th>نام مشتری <i class="bi bi-funnel filter-icon" onclick="toggleFilter('customer-name', event)"></i></th>
      <th>نام ویزیتور</th>
        <th>وضعیت <i class="bi bi-funnel filter-icon" onclick="toggleFilter('status', event)"></i></th>
        <th>عملیات</th>
      </tr>
    </thead>
    <tbody>
      {% for order in backordered_requests %}
      <tr data-order-id="{{ order.id }}">
        <td>{{ order.created_at|jformat:"%Y/%m/%d" }}</td>
        <td>{{ order.order_number }}</td>
        <td>{{ order.customer_name }}</td>
        <td>{{ order.visitor_name|get_user_full_name }}</td>
        <td><span class="order-status status-backorder">در انتظار موجودی</span></td>
        <td>
          <button class="action-button details-button" onclick="toggleDetails('details-row-backordered-{{ order.id }}')" title="جزئیات">
            <i class="bi bi-eye-fill"></i>
          </button>
          <a href="{% url 'products:backorder_pdf' order.id %}" target="_blank" class="print-button" title="چاپ">
            <i class="bi bi-printer"></i>
          </a>
          
        </td>
      </tr>
      <tr id="details-row-backordered-{{ order.id }}" class="details-content-row">
        <td colspan="6">

          {% if order.items.all %}
          <div class="table-wrapper">
            <table class="items-table">
              <thead>
                <tr>
                  <th>کد کالا</th>
                  <th>نام محصول</th>
                  <th>تعداد</th>
                  <th>قیمت واحد</th>
                  <th>جمع</th>
                  <th>تسویه</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order.items.all %}
                <tr data-item-id="{{ item.id }}">
                  <td>{{ item.product.code|default:"-" }}</td>
                  <td>{{ item.product.name|default:"-" }}</td>
                  <td>{{ item.requested_quantity }}</td>
                  <td>{{ item.price|floatformat:0|default:0 }} ریال</td>
                  <td>{{ item.total_price|floatformat:0|default:0 }} ریال</td>
                  <td>{{ item.get_payment_term_display|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6">هیچ کالایی یافت نشد.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if order.items.all %}
          <h5 style="margin-top: 20px;">تخصیص دستی یا ارسال آیتم به انبار</h5>
          <table class="items-table" id="backorder-items-{{ order.id }}">
            <thead>
              <tr>
                <th>
                  <input type="checkbox" onclick="toggleAllCheckboxes(this, '{{ order.id }}')" title="انتخاب همه">
                </th>
                <th>کد کالا</th>
                <th>نام محصول</th>
                <th>تعداد مورد نیاز</th>
                <th>قیمت (قابل تغییر)</th>
                <th>تعداد</th>
                <th>وضعیت</th>
              </tr>
            </thead>
            <tbody>
              {% for item in order.items.all %}
              <tr>
                <td>
                  <input type="checkbox" class="item-checkbox" data-item-id="{{ item.id }}">
                </td>
                <td>{{ item.product.code }}</td>
                <td>{{ item.product.name }}</td>
                <td>{{ item.requested_quantity }}</td>
                <td>
                  <input type="number" value="{{ item.price }}" class="form-control price-input" style="width: 100px"
                         data-item-id="{{ item.id }}" name="price_{{ item.id }}">
                </td>
                <td>
                  <input type="number" value="0" min="0" max="{{ item.requested_quantity }}" class="form-control quantity-input" style="width: 80px"
                         data-item-id="{{ item.id }}" name="quantity_{{ item.id }}">
                </td>
                <td>در انتظار موجودی</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div style="margin: 15px 0;">
            <div class="form-group" style="margin-bottom: 10px;">
              <label>شماره سند:</label>
              <input type="text" 
                     class="document-number" 
                     id="doc_{{ order.id }}" 
                     required 
                     pattern="\S+">
            </div>
            <div class="form-group">
              <label>تعداد بسته:</label>
              <input type="number" 
                     class="document-number" 
                     id="package_count_{{ order.id }}" 
                     required 
                     min="1" 
                     placeholder="تعداد بسته">
            </div>
          </div>
          <button class="btn btn-success" onclick="submitAllocation('{{ order.id }}')">ثبت تخصیص‌ها</button>
          <button class="btn btn-warning" onclick="sendSelectedItemsToWarehouse('{{ order.id }}')">ارسال موارد انتخابی به انبار</button>
          {% endif %}
          {% else %}
          <p>هیچ آیتمی برای این سفارش وجود ندارد.</p>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5">هیچ سفارشی یافت نشد.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="BackorderReady" class="tabcontent">
  <h2>بک اوردرهای آماده ارسال</h2>
  <table class="orders-table" id="backorder-ready-orders">
    <thead>
      <tr>
        <th>تاریخ</th>
        <th>شماره سفارش</th>
        <th>نام مشتری</th>
        <th>نام ویزیتور</th>
        <th>شماره سند</th>
        <th>تعداد بسته</th>
        <th>وضعیت</th>
        <th>عملیات</th>
      </tr>
    </thead>
    <tbody>
      {% for order in backorder_ready_requests %}
      <tr>
        <td>{{ order.created_at|jformat:"%Y/%m/%d" }}</td>
        <td>{{ order.order_number }}</td>
        <td>{{ order.customer_name }}</td>
        <td>{{ order.visitor_name|get_user_full_name }}</td>
        <td>{{ order.document_number|default:"-" }}</td>
        <td>{{ order.package_count|default:"-" }}</td>
        <td><span class="order-status status-backorder-ready">آماده ارسال</span></td>
        <td>
          <button class="action-button details-button" onclick="toggleDetails('details-row-backorder-ready-{{ order.id }}')" title="جزئیات">
            <i class="bi bi-eye-fill"></i>
          </button>
          <button class="action-button next-stage-button" id="send-btn-{{ order.id }}" onclick="sendBackorderToCustomer('{{ order.id }}')" title="مرحله بعدی">
            <i class="bi bi-arrow-right-circle"></i>
          </button>
        </td>
      </tr>
      <tr id="details-row-backorder-ready-{{ order.id }}" class="details-content-row">
        <td colspan="7">
          {% if order.items.all %}
          <div class="table-wrapper">
            <table class="items-table">
              <thead>
                <tr>
                  <th>کد کالا</th>
                  <th>نام محصول</th>
                  <th>تعداد</th>
                  <th>قیمت واحد</th>
                  <th>جمع</th>
                  <th>تسویه</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order.items.all %}
                <tr>
                  <td>{{ item.product.code|default:"-" }}</td>
                  <td>{{ item.product.name|default:"-" }}</td>
                  <td>{{ item.requested_quantity }}</td>
                  <td>{{ item.price|floatformat:0|default:0 }} ریال</td>
                  <td>{{ item.total_price|floatformat:0|default:0 }} ریال</td>
                  <td>{{ item.get_payment_term_display|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6">هیچ کالایی یافت نشد.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p>هیچ آیتمی برای این سفارش وجود ندارد.</p>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7">هیچ سفارشی یافت نشد.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="Shipped" class="tabcontent">
  <h2>سفارشات ارسال شده</h2>
  <table class="orders-table" id="shipped-orders">
      <thead>
          <tr>
              <th>تاریخ ارسال</th>
              <th>شماره ارسال</th>
              <th>نام مشتری</th>
              <th>نام ویزیتور</th>
              <th>نام پیک</th>
              <th>عملیات</th>
          </tr>
      </thead>
      <tbody>
          {% for shipment in shipped_shipments %}
          <tr>
              <td>{{ shipment.shipment_date|jformat:'%Y/%m/%d %H:%M' }}</td>
              <td>{{ shipment.shipment_number|default:'-' }}</td>
              <td>
                {# اگر سفارش اصلی بود نام مشتری، اگر زیرسفارش‌ها داشت اولی را نمایش بده #}
                {% if shipment.order.customer_name %}
                    {{ shipment.order.customer_name }}
                {% elif shipment.sub_orders.first %}
                    {{ shipment.sub_orders.first.customer_name }}
                {% else %}
                    -
                {% endif %}
              </td>
              <td>{{ shipment.order.visitor_name|get_user_full_name }}</td>
              <td>{{ shipment.courier_name|default:'-' }}</td>
              <td>
                  <button class="action-button details-button" onclick="toggleDetails('details-row-shipped-{{ shipment.id }}')" title="جزئیات و نهایی‌سازی">
                    <i class="bi bi-pencil-square"></i>
                  </button>
              </td>
          </tr>
          <tr id="details-row-shipped-{{ shipment.id }}" class="details-content-row">
            <td colspan="6">
              <div>
                {% include 'products/partials/order_details_partial.html' with order=shipment.order is_finalizing=True shipment_id=shipment.id prefix='shipped' %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
              <td colspan="6">هیچ ارسال ثبت نشده است.</td>
          </tr>
          {% endfor %}
      </tbody>
  </table>
</div>

<div id="Delivered" class="tabcontent">
  <h2>سفارشات نهایی شده</h2>
  <table class="orders-table" id="delivered-orders">
      <thead>
          <tr>
              <th>تاریخ ارسال</th>
              <th>شماره ارسال</th>
              <th>نام مشتری</th>
              <th>نام ویزیتور</th>
              <th>نام پیک</th>
              <th>عملیات</th>
          </tr>
      </thead>
      <tbody>
          {% for shipment in delivered_shipments %}
          <tr>
              <td>{{ shipment.shipment_date|jformat:'%Y/%m/%d %H:%M' }}</td>
              <td>{{ shipment.shipment_number|default:'-' }}</td>
              <td>{{ shipment.order.customer_name }}</td>
              <td>{{ shipment.order.visitor_name|get_user_full_name }}</td>
              <td>{{ shipment.courier_name|default:'-' }}</td>
              <td>
                <a href="{% url 'products:sales_invoice_pdf' shipment.id %}" target="_blank" class="action-button print-button" title="چاپ فاکتور">
                    <i class="bi bi-receipt"></i>
                </a>
                <button class="action-button details-button" onclick="toggleDetails('details-row-delivered-{{ shipment.id }}')" title="جزئیات">
                    <i class="bi bi-eye-fill"></i>
                </button>
              </td>
          </tr>
          <tr id="details-row-delivered-{{ shipment.id }}" class="details-content-row">
              <td colspan="6">
                <div>
                  {% include 'products/partials/order_details_partial.html' with order=shipment.order is_finalizing=False prefix='delivered' %}
                </div>
              </td>
          </tr>
          {% empty %}
          <tr>
              <td colspan="6">هیچ سفارش نهایی شده‌ای یافت نشد.</td>
          </tr>
          {% endfor %}
      </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<!-- Persian Datepicker -->
<script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

<script>
  function openTabByName(tabName, clickedElement) {
    console.log('Opening tab:', tabName);
    var tabcontent = document.getElementsByClassName("tabcontent");
    for (var i = 0; i < tabcontent.length; i++) {
      tabcontent[i].classList.remove("active");
    }
    var cards = document.getElementsByClassName("tile-card");
    for (var j = 0; j < cards.length; j++) {
      cards[j].classList.remove("active");
    }
    document.getElementById(tabName).classList.add("active");
    if (clickedElement) clickedElement.classList.add("active");

    // Close all previously open detail rows when changing tabs
    var allDetailRows = document.querySelectorAll('.details-content-row.active');
    allDetailRows.forEach(row => row.classList.remove('active'));
  }

  function toggleDetails(id) {
    console.log('Toggling details for ID:', id);
    var detailRow = document.getElementById(id);
    if (detailRow) {
      detailRow.classList.toggle("active");
      console.log('Row toggled:', id, 'Active:', detailRow.classList.contains('active'));
    } else {
      console.error('Error: Row with ID ' + id + ' not found');
    }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function moveToNext(orderId, currentStatus) {
    if (!confirm('آیا از تغییر وضعیت این سفارش اطمینان دارید؟')) {
      return;
    }

    let requestData = {
      order_id: orderId,
      current_status: currentStatus
    };

    // اگر وضعیت در انتظار ارسال به مشتری است، نام پیک را هم ارسال می‌کنیم
    if (currentStatus === 'waiting_for_customer_shipment') {
        const courierInput = document.getElementById(`courier-${orderId}`);
        if (!courierInput || !courierInput.value.trim()) {
            // This case handles parent orders where the input is in the details row
            const parentCourierInput = document.getElementById(`courier-${orderId}`);
            if (parentCourierInput && parentCourierInput.value.trim()){
                requestData.courier_name = parentCourierInput.value.trim();
            } else {
                alert('لطفاً نام پیک را وارد کنید.');
                return;
            }
        } else {
            requestData.courier_name = courierInput.value.trim();
        }
    } else if (currentStatus === 'shipped') {
        // This is the finalization step. We gather the delivered quantities.
        const items = [];
        const itemRows = document.querySelectorAll(`#details-row-shipped-${orderId} [data-item-id]`);
        let allQuantitiesValid = true;

        itemRows.forEach(row => {
            const itemId = row.dataset.itemId;
            const deliveredQtyInput = document.getElementById(`delivered-qty-${itemId}`);
            const allocatedQty = parseInt(row.dataset.allocated, 10);
            const deliveredQty = parseInt(deliveredQtyInput.value, 10);

            if (isNaN(deliveredQty) || deliveredQty < 0 || deliveredQty > allocatedQty) {
                alert(`مقدار تحویلی برای کالای ${row.cells[1].innerText} نامعتبر است. باید بین 0 و ${allocatedQty} باشد.`);
                allQuantitiesValid = false;
            }
            items.push({ id: itemId, delivered_quantity: deliveredQty });
        });

        if (!allQuantitiesValid) return;
        requestData.items = items;
    }


    fetch('/api/update-order-status/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(requestData)
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.message || 'خطای نامشخص در سرور');
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        alert('عملیات با موفقیت انجام شد');
        location.reload();
      } else {
        alert('خطا: ' + (data.message || 'خطای نامشخص'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('خطا: ' + error.message);
    });
  }

  function finalizeShippedOrder(shipmentId) {
      if (!confirm('آیا از نهایی کردن این ارسال اطمینان دارید؟ مقادیر کالا و انبار به‌روزرسانی خواهند شد.')) {
          return;
      }

      const itemsData = [];
      const detailsContainer = document.getElementById(`details-row-shipped-${shipmentId}`);
      const itemInputs = detailsContainer.querySelectorAll('input[name="delivered_quantity"]');
      let isValid = true;

      itemInputs.forEach(input => {
          const itemId = input.dataset.itemId;
          const allocatedQty = parseInt(input.max, 10);
          const deliveredQty = parseInt(input.value, 10);

          if (isNaN(deliveredQty) || deliveredQty < 0 || deliveredQty > allocatedQty) {
              alert(`مقدار وارد شده برای یکی از کالاها نامعتبر است. لطفاً عددی بین 0 و ${allocatedQty} وارد کنید.`);
              input.style.border = '2px solid red';
              isValid = false;
          } else {
              input.style.border = '';
              itemsData.push({
                  item_id: itemId,
                  delivered_quantity: deliveredQty
              });
          }
      });

      if (!isValid) {
          return;
      }

      fetch('/api/update-order-status/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
              shipment_id: shipmentId,
              current_status: 'shipped', // Action is 'finalize'
              items: itemsData
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              alert('ارسال با موفقیت نهایی شد.');
              location.reload();
          } else {
              alert('خطا در نهایی‌سازی: ' + (data.message || 'خطای نامشخص'));
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('خطای ارتباط با سرور.');
      });
  }

  function editOrder(orderId) {
    window.location.href = `/edit-order/${orderId}/`;
  }

  function logout() {
    window.location.href = "{% url 'products:manager_dashboard' %}";
  }

  function toggleAdvancedSearch() {
    const searchFields = document.getElementById('search-fields');
    const searchActions = document.getElementById('search-actions');
    const isVisible = searchFields.classList.contains('show');
    
    if (isVisible) {
        searchFields.classList.remove('show');
        searchActions.style.display = 'none';
    } else {
        searchFields.classList.add('show');
        searchActions.style.display = 'flex';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
      // Initialize Persian Datepickers
      $(".persian-datepicker").persianDatepicker({
          format: 'YYYY/MM/DD',
          initialValue: false,
          autoClose: true,
          persianDigit: true,
          observer: true,
          calendar: {
              persian: {
                  locale: 'fa'
              }
          }
      });

      // Show search fields if there are any active filters
      const urlParams = new URLSearchParams(window.location.search);
      let hasFilter = false;
      for (const [key, value] of urlParams.entries()) {
        if (value) {
          hasFilter = true;
          break;
        }
      }
      if (hasFilter) {
        toggleAdvancedSearch();
      }
  });


  window.onload = function () {
    console.log('Page loaded, selecting first tab');
    var firstCard = document.querySelector(".tiles-container .tile-card");
    if (firstCard) firstCard.click();
  };

  function submitAllocation(orderId) {
    const docNumber = document.getElementById(`doc_${orderId}`).value;
    const packageCount = document.getElementById(`package_count_${orderId}`).value;
    
    if (!docNumber) {
        alert('لطفاً شماره سند را وارد کنید');
        return;
    }
    
    if (!packageCount || packageCount < 1) {
        alert('لطفاً تعداد بسته را وارد کنید');
        return;
    }

    const rows = document.querySelectorAll(`#backorder-items-${orderId} .quantity-input`);
    const items = [];

    let totalAllocated = 0;
    rows.forEach(input => {
        const quantity = parseInt(input.value) || 0;
        const maxQuantity = parseInt(input.getAttribute('max')) || 0;
        
        if (quantity > maxQuantity) {
            alert(`تعداد تخصیص نمی‌تواند از تعداد مورد نیاز (${maxQuantity}) بیشتر باشد.`);
            return;
        }
        
        if (quantity > 0) {
            const itemId = input.getAttribute('data-item-id');
            const priceInput = document.querySelector(`[name="price_${itemId}"]`);
            const price = parseInt(priceInput.value);
            items.push({
                item_id: itemId,
                quantity: quantity,
                price: price
            });
            totalAllocated += quantity;
        }
    });

    if (items.length === 0) {
        alert('لطفاً حداقل یک مقدار تخصیص وارد کنید.');
        return;
    }

    if (totalAllocated === 0) {
        alert('مجموع تخصیص‌ها نمی‌تواند صفر باشد.');
        return;
    }

    fetch('/api/submit-allocation/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            order_id: orderId,
            items: items,
            document_number: docNumber,
            package_count: parseInt(packageCount)
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('تخصیص با موفقیت انجام شد.');
            location.reload();
        } else {
            alert(result.message || 'خطا در ثبت تخصیص');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('خطا در ارسال اطلاعات تخصیص.');
    });
  }
   
  function checkCourierInput(subOrderId) {
    const input = document.getElementById(`courier-${subOrderId}`);
    const button = document.getElementById(`send-button-${subOrderId}`);
    button.disabled = !(input.value.trim().length > 0);
  }
  
  function sendSubOrder(subOrderId) {
    const courierName = document.getElementById(`courier-${subOrderId}`).value.trim();
    if (!courierName) {
      alert("نام پیک را وارد کنید.");
      return;
    }
  
    fetch('/api/update-order-status/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        order_id: subOrderId,
        current_status: 'waiting_for_customer_shipment',
        courier_name: courierName
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("سفارش ارسال شد.");
        location.reload();
      } else {
        alert("خطا در ارسال سفارش: " + (data.message || "نامشخص"));
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("خطا در ارتباط با سرور.");
    });
  }

  function checkParentCourierInput(orderId) {
    const input = document.getElementById(`courier-${orderId}`);
    const button = document.getElementById(`send-all-button-${orderId}`);
    button.disabled = !(input.value.trim().length > 0);
  }
  
  function sendAllSubOrders(orderId) {
    const courierName = document.getElementById(`courier-${orderId}`).value.trim();
    if (!courierName) {
      alert("نام پیک را وارد کنید.");
      return;
    }
  
    fetch('/api/update-order-status/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        order_id: orderId,
        current_status: 'waiting_for_customer_shipment',
        courier_name: courierName
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("همه زیرسفارش‌ها با موفقیت ارسال شدند.");
        location.reload();
      } else {
        alert("خطا در ارسال سفارش‌ها: " + (data.message || "نامشخص"));
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("خطا در ارتباط با سرور.");
    });
  }

  function sendItemToWarehouse(itemId) {
    if (!confirm('آیا از ارسال این کالا به انبار اطمینان دارید؟')) {
      return;
    }

    // مقدار تعداد را از input مربوطه بخوان
    var qtyInput = document.getElementById('send_to_warehouse_qty_' + itemId);
    var quantity = qtyInput ? parseInt(qtyInput.value, 10) : 0;

    if (!quantity || quantity <= 0) {
      alert('لطفاً یک تعداد معتبر (بزرگتر از صفر) وارد کنید.');
      if (qtyInput) qtyInput.focus();
      return;
    }

    fetch('/api/send-item-to-warehouse/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        item_id: itemId,
        quantity: quantity  // 👈 اضافه شد
      })
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.message || 'خطای نامشخص در سرور');
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        alert('کالا با موفقیت به انبار ارسال شد.');
        
        // حذف ردیف آیتم از جدول
        const itemRow = document.querySelector(`tr[data-item-id="${data.item_id}"]`);
        if (itemRow) itemRow.remove();
        if (data.order_should_remove) {
            const orderRow = document.querySelector(`tr[data-order-id="${data.order_id}"]`);
            if (orderRow) orderRow.remove();
        }

        // اگر باید کل سفارش حذف شود
        if (data.order_should_remove) {
          const orderRow = document.querySelector(`tr[data-order-id="${data.order_id}"]`);
          const detailsRow = document.getElementById(`details-row-backordered-${data.order_id}`);
          if (orderRow) orderRow.remove();
          if (detailsRow) detailsRow.remove();
        }
      } else {
        alert('خطا: ' + (data.message || 'خطای نامشخص'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('خطا در ارسال کالا به انبار: ' + error.message);
    });
  }

  // بعد از حذف سفارش یا آیتم
  const backorderCountElem = document.querySelector('.tile-backordered .tile-count');
  if (backorderCountElem) {
    // تعداد سفارشات باقی‌مانده را دوباره بشمار
    const visibleOrders = document.querySelectorAll('#backordered-orders tr[data-order-id]');
    backorderCountElem.textContent = visibleOrders.length;
  }

  function toggleAllCheckboxes(source, orderId) {
    const checkboxes = document.querySelectorAll(`#backorder-items-${orderId} .item-checkbox`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = source.checked;
    });
  }

  function sendSelectedItemsToWarehouse(orderId) {
    const selectedItems = [];
    const checkboxes = document.querySelectorAll(`#backorder-items-${orderId} .item-checkbox:checked`);

    checkboxes.forEach(checkbox => {
        const itemId = checkbox.getAttribute('data-item-id');
        const quantityInput = document.querySelector(`#backorder-items-${orderId} [name="quantity_${itemId}"]`);
        const quantity = parseInt(quantityInput.value) || 0;

        if (quantity > 0) {
            selectedItems.push({
                item_id: itemId,
                quantity: quantity
            });
        }
    });

    if (selectedItems.length === 0) {
        alert('لطفاً حداقل یک کالا با تعداد مشخص برای ارسال انتخاب کنید.');
        return;
    }

    if (!confirm(`آیا از ارسال ${selectedItems.length} مورد به انبار اطمینان دارید؟`)) {
        return;
    }

    fetch('/api/send-items-to-warehouse/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            order_id: orderId,
            items: selectedItems
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message || 'موارد با موفقیت به انبار ارسال شدند.');
            location.reload();
        } else {
            alert(result.message || 'خطا در ارسال موارد به انبار.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('خطا در ارتباط با سرور.');
    });
  }

  function toggleSendButton(orderId) {
    const courierInput = document.getElementById('courier-' + orderId);
    const sendBtn = document.getElementById('send-btn-' + orderId);
    if (courierInput && sendBtn) {
      sendBtn.disabled = !courierInput.value.trim();
    }
  }

  function sendBackorderToCustomer(orderId, currentStatus = 'ready') {
const courierInput = document.getElementById('courier-' + orderId);
const courierName = courierInput ? courierInput.value.trim() : '';

// فقط اگر می‌خواهی سفارش را Delivered کنی، نام پیک را چک کن
if (currentStatus === 'waiting_for_customer_shipment' && !courierName) {
  alert('لطفاً نام پیک را وارد کنید.');
  courierInput.focus();
  return;
}

fetch('/api/update-order-status/', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRFToken': getCookie('csrftoken')
  },
  body: JSON.stringify({
    order_id: orderId,
    current_status: currentStatus,
    courier_name: courierName
  })
})
.then(response => response.json())
.then(data => {
  if (data.success) {
    alert('سفارش با موفقیت ارسال شد.');
    location.reload();
  } else {
    alert('خطا: ' + (data.message || 'خطای نامشخص'));
  }
})
.catch(error => {
  alert('خطا در ارتباط با سرور.');
});
}
</script>
{% endblock %}