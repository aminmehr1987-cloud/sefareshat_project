{% comment %}
This partial template renders the sub-orders associated with a single shipment.
It expects a `shipment` object.
{% endcomment %}
{% load custom_filters %}
{% load shipment_extras %}

<style>
/* Responsive column widths for shipment details table */
.items-table th:nth-child(1), .items-table td:nth-child(1) { width: 10%; min-width: 80px; } /* کد کالا */
.items-table th:nth-child(2), .items-table td:nth-child(2) { width: 15%; min-width: 100px; } /* نام محصول */
.items-table th:nth-child(3), .items-table td:nth-child(3) { width: 8%; min-width: 70px; } /* تعداد درخواستی */
.items-table th:nth-child(4), .items-table td:nth-child(4) { width: 8%; min-width: 70px; } /* تعداد تخصیص یافته */
.items-table th:nth-child(5), .items-table td:nth-child(5) { width: 10%; min-width: 80px; } /* تعداد تحویلی */
.items-table th:nth-child(6), .items-table td:nth-child(6) { width: 12%; min-width: 90px; } /* قیمت واحد */
.items-table th:nth-child(7), .items-table td:nth-child(7) { width: 20%; min-width: 120px; } /* جمع کل */
.items-table th:nth-child(8), .items-table td:nth-child(8) { width: 7%; min-width: 60px; } /* تسویه */

/* Mobile responsiveness */
@media (max-width: 768px) {
  .items-table th:nth-child(1), .items-table td:nth-child(1) { width: 12%; min-width: 60px; }
  .items-table th:nth-child(2), .items-table td:nth-child(2) { width: 18%; min-width: 80px; }
  .items-table th:nth-child(3), .items-table td:nth-child(3) { width: 10%; min-width: 50px; }
  .items-table th:nth-child(4), .items-table td:nth-child(4) { width: 10%; min-width: 50px; }
  .items-table th:nth-child(5), .items-table td:nth-child(5) { width: 12%; min-width: 60px; }
  .items-table th:nth-child(6), .items-table td:nth-child(6) { width: 14%; min-width: 70px; }
  .items-table th:nth-child(7), .items-table td:nth-child(7) { width: 24%; min-width: 100px; }
  .items-table th:nth-child(8), .items-table td:nth-child(8) { width: 8%; min-width: 50px; }
}
</style>

<style>
  .finalize-shipment-btn:disabled {
    background: #d9d9d9 !important;
    color: #777 !important;
    border-color: #d0d0d0 !important;
    cursor: not-allowed !important;
    opacity: 1 !important;
  }
  .ltr-number {
    direction: ltr;
    unicode-bidi: bidi-override;
    display: inline-block;
  }
</style>

<div class="table-wrapper">
  <h4>فاکتورهای ارسال شده:</h4>
  <table class="items-table">
    <thead>
      <tr id="suborder-row-{{ sub_order.id }}">
        <th>شماره زیرسفارش</th>
        <th>انبار</th>
        <th>نوع سفارش</th>
        <th>وضعیت</th>
        <th>شماره سند</th>
        <th>تعداد بسته</th>
        <th>عملیات</th>
      </tr>
    </thead>
    <tbody>
      {% get_sub_orders_for_shipment shipment as sub_orders_list %}
      {% for sub_order in sub_orders_list %}
      <tr>
        <td>{{ sub_order.order_number }}</td>
        <td>
          {% if sub_order.items.first and sub_order.items.first.warehouse %}
            {{ sub_order.items.first.warehouse.name }}
          {% elif sub_order.warehouse %}
            {{ sub_order.warehouse.name }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if sub_order.order_number|slice:":2" == "BO" %}
            بک‌اوردر
          {% else %}
            عادی
          {% endif %}
        </td>
        <td>
          <span id="suborder-status-{{ sub_order.id }}" class="order-status status-{{ sub_order.status }}">{{ sub_order.get_status_display }}</span>
        </td>
        <td>{{ sub_order.document_number|default:"-" }}</td>
        <td>{{ sub_order.package_count|default:"-" }}</td>
        <td>
          {% if is_delivered %}
          <a href="{% url 'products:sales_invoice_pdf' sub_order.id %}" target="_blank" class="action-button print-button" title="چاپ فاکتور">
            <i class="bi bi-receipt"></i>
          </a>
          {% endif %}
          <button class="action-button details-button" onclick="toggleDetails('shipment-sub-details-{{ sub_order.id }}')" title="مشاهده جزئیات فاکتور">
            <i class="bi bi-eye-fill"></i>
          </button>
        </td>
      </tr>
      <tr id="shipment-sub-details-{{ sub_order.id }}" class="details-content-row">
        <td colspan="7">
          <h5>جزئیات فاکتور زیرسفارش {{ sub_order.order_number }}:</h5>
          <div class="table-wrapper">
            <table class="items-table">
              <thead>
                <tr>
                  <th>کد کالا</th>
                  <th>نام محصول</th>
                  <th>تعداد درخواستی</th>
                  <th>تعداد تخصیص یافته</th>
                  <th>تعداد تحویلی</th>
                  <th>قیمت واحد</th>
                  <th>جمع کل</th>
                  <th>تسویه</th>
                </tr>
              </thead>
              <tbody>
                {% for item in sub_order.items.all %}
                {% if item.allocated_quantity and item.allocated_quantity|add:0 > 0 %}
                <tr data-item-id="{{ item.id }}" data-allocated="{{ item.allocated_quantity|default:0 }}">
                  <td>{{ item.product.code }}</td>
                  <td>{{ item.product.name }}</td>
                  <td>{{ item.requested_quantity }}</td>
                  <td>{{ item.allocated_quantity|default:"-" }}</td>
                  <td>
                    {% if not is_delivered %}
                    <input type="number" 
                           id="delivered-qty-{{ item.id }}" 
                           name="delivered_quantity" 
                           data-item-id="{{ item.id }}"
                           data-unit-price="{{ item.price|default:0 }}"
                           value="{{ item.delivered_quantity|default:0 }}" 
                           min="0" 
                           max="{{ item.allocated_quantity|default:0 }}"
                           class="form-control delivered-qty-input"
                           style="width: 80px; text-align: center;"
                           onchange="updateItemTotal('{{ item.id }}')">
                    {% else %}
                      {{ item.delivered_quantity|default:"0" }}
                    {% endif %}
                  </td>
                  <td>{{ item.price|floatformat:0 }} ریال</td>
                  <td id="total-{{ item.id }}">{{ item.price|multiply:item.delivered_quantity|floatformat:0 }} ریال</td>
                  <td>{{ item.get_payment_term_display }}</td>
                </tr>
                {% endif %}
                {% empty %}
                <tr><td colspan="8">هیچ کالایی برای این زیرسفارش یافت نشد.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- خلاصه فاکتور -->
          <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e9ecef;">
            <h6 style="margin-bottom: 10px; font-weight: bold;">خلاصه فاکتور:</h6>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
              <div><strong>مجموع اقلام:</strong> {{ sub_order.items.count }} قلم</div>
              <div><strong>مجموع تعداد تحویلی:</strong> 
                {% with total_delivered=sub_order.items.all|sum_delivered_quantity %}
                  {{ total_delivered|default:"0" }}
                {% endwith %}
              </div>
              <div><strong>مجموع مبلغ:</strong> 
                {% with total_amount=sub_order.items.all|sum_total_delivered_amount %}
                  {{ total_amount|floatformat:0|default:"0" }} ریال
                {% endwith %}
              </div>
              <div><strong>تاریخ تحویل:</strong> 
                {% if shipment.delivery_date %}
                  {{ shipment.delivery_date|jformat:'%Y/%m/%d %H:%M' }}
                {% else %}
                  {{ shipment.shipment_date|jformat:'%Y/%m/%d %H:%M' }}
                {% endif %}
              </div>
            </div>
          </div>
          
          {% if not is_delivered %}
          <!-- دکمه نهایی کردن فاکتور -->
          <div style="margin-top: 15px; text-align: center; padding: 10px; border-top: 2px solid #ddd;">
            <button class="btn btn-success finalize-suborder-btn" 
                    data-suborder-id="{{ sub_order.id }}"
                    onclick="finalizeSubOrder('{{ sub_order.id }}', '{{ shipment.id }}')" 
                    style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-size: 14px; font-weight: bold;">
              <i class="bi bi-check-circle"></i> نهایی کردن فاکتور {{ sub_order.order_number }}
            </button>
          </div>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7">هیچ زیرسفارشی در این ارسال یافت نشد.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  
  <!-- دکمه نهایی کردن کل ارسال -->
  {% if sub_orders_list %}
  {% if not is_delivered %}
  <div style="margin-top: 20px; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
    <button class="btn btn-primary finalize-shipment-btn" 
            data-shipment-id="{{ shipment.id }}"
            onclick="finalizeEntireShipment('{{ shipment.id }}')" 
            style="background: #007bff; color: white; border: none; padding: 12px 25px; border-radius: 5px; font-size: 16px; font-weight: bold;"
            disabled>
      <i class="bi bi-truck"></i> نهایی کردن کل ارسال شماره <span class="ltr-number">{{ shipment.shipment_number }}</span>
    </button>
  </div>
  {% endif %}
  {% endif %}
</div>
